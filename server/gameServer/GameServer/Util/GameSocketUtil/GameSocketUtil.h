// ============================================================================
// myungdal tech-demo project
// 
// Author: 안명달 (Myungdal Ahn)
// Email: mooondal@gmail.com
// GitHub: https://github.com/myungdal/tech_demo.git
// ============================================================================

#pragma once

#include "Packet/NetworkPacketAutoGenerated/PacketFwd.h"

#include "ServerEngine/Util/SocketUtil/SocketUtil.h"
#include "ServerEngine/AppListManager/AppListManager.h"


class SocketGameToDb;
class SocketGameFromFront;

struct GameSocketUtil
{
	static SocketPtr<SocketGameToDb> GetDbSocket(AppId appId);
	static SocketPtr<SocketGameFromFront> GetFrontSocket(AppId appId);

	template <typename _Packet>
	using SendToClient = SocketUtil::SendBypassToUser<GF_GC_BYPASS::Writer, _Packet>;

	template<typename _Packet>
	class BroadcastToFrontServers : public _Packet
	{
	public:
		template<typename... _Args>
		explicit BroadcastToFrontServers(PacketTraitType trait, _Args&&... args)
			:
			_Packet(trait, TEMP_BUF, std::forward<_Args>(args)...)
		{
		}

		virtual ~BroadcastToFrontServers()
		{
			auto [appIdList, lock] = gAppListManager->GetAppIdList(AppType::FRONT_SERVER);
			if (!appIdList || appIdList->empty())
				return;

			for (AppId appId : *appIdList)
			{
				auto [appInfo, _] = gAppListManager->FindAppInfo(appId);
				if (!appInfo)
					continue;

				auto socket = appInfo->GetSocket();
				if (!socket)
					continue;

				SocketUtil::Send<NetworkPacketWriter> wp(**socket);
				std::copy_n(this->GetPacketBufPtr(), this->GetPacketSize(), wp.GetPacketBufPtr());
			}
		}
	};

	template<typename _Packet>
	class BroadcastToFrontUsers : public _Packet
	{
	public:
		const GameChannelUserIdTable& mUserIdTable;

		template<typename... _Args>
		explicit BroadcastToFrontUsers(const GameChannelUserIdTable& userIdTable, PacketTraitType trait, _Args&&... args)
			:
			mUserIdTable(userIdTable),
			_Packet(trait, TEMP_BUF, std::forward<_Args>(args)...)
		{
		}

		virtual ~BroadcastToFrontUsers()
		{
			for (size_t i = 0; i < mUserIdTable.size(); ++i)
			{
				const UserIdList& userIdList = mUserIdTable[i];
				if (true == userIdList.empty())
					continue;

				const AppId appId = static_cast<AppId>(i);
				auto [appInfo, lock] = gAppListManager->FindAppInfo(appId);
				if (!appInfo)
					continue;

				SocketBase* socket = appInfo->GetSocket();
				if (!socket)
					continue;

				SocketUtil::Send<GF_GC_BYPASS::Writer> wp(*socket, NOTIFY);
				wp.SetHeader(wp.ConstGetHeader());
				wp.SetValues(
					userIdList.data(),
					static_cast<PacketSize>(userIdList.size()),
					this->GetPacketBufPtr(),
					this->GetPacketSize()
				);
			}
		}
	};

	template<typename _Packet>
	class BroadcastToFrontGameUsers : public _Packet
	{
	public:
		const GameChannelUserIdTable& mUserIdTable;

		template<typename... _Args>
		explicit BroadcastToFrontGameUsers(const GameChannelUserIdTable& userIdTable, PacketTraitType trait, _Args&&... args)
			:
			mUserIdTable(userIdTable),
			_Packet(trait, TEMP_BUF, std::forward<_Args>(args)...)
		{
		}

		virtual ~BroadcastToFrontGameUsers()
		{
			for (size_t i = 0; i < mUserIdTable.size(); ++i)
			{
				const UserIdList& userIdList = mUserIdTable[i];
				if (true == userIdList.empty())
					continue;

				const AppId appId = static_cast<AppId>(i);
				auto [appInfo, lock] = gAppListManager->FindAppInfo(appId);
				if (!appInfo)
					continue;

				auto socket = appInfo->GetSocket();
				if (!socket)
					continue;

				SocketUtil::Send<GF_GC_BYPASS_GAME::Writer> wp(**socket, NOTIFY);
				wp.SetHeader(this->ConstGetHeader());
				wp.SetValues(
					this->GetPacketBufPtr(),
					this->GetPacketSize()
				);
			}
		}
	};
};
