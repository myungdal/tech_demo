// ============================================================================
// myungdal tech-demo project
// 
// Author: 안명달 (Myungdal Ahn)
// Email: mooondal@gmail.com
// GitHub: https://github.com/myungdal/tech_demo.git
// ============================================================================

import LogServer;
import ServerEnginePacketAutoGenerated;


void SocketLogToMain::OnAppAdded(IN OUT MAYBE_UNUSED AppInfo& appInfo)
{
}

bool SocketLogToMain::OnDispatchPacket(NetworkPacket& rp)
{
	DispatchPacket(rp);
	return true;
}

void SocketLogToMain::DispatchPacket(NetworkPacket& rp)
{
	if (LogPacketWorkerPtr worker = gLogPacketHandler->GetLogPacketWorker(rp))
		PacketUtil::DispatchPacketOnWorker(worker, this, &SocketLogToMain::DispatchPacket_async, rp, worker);
	else if (tThreadId == INVALID_THREAD_ID)
		PacketUtil::DispatchPacketOnAnyThread(this, &SocketLogToMain::DispatchPacket_async, rp, worker);
	else
		DispatchPacketToHandler(rp, worker);
}

void SocketLogToMain::DispatchPacket_async(MAYBE_UNUSED SocketPtrType& ptr, PacketTemp tp, LogPacketWorkerPtr worker)
{
	DispatchPacketToHandler(**tp, worker);
}

void SocketLogToMain::DispatchPacketToHandler(NetworkPacket& rp, LogPacketWorkerPtr worker)
{
	auto DispatchPacketToHandler = [this](auto handler, NetworkPacket& rp, LogPacketWorkerPtr worker)
		{
			if (DispatchPacketML(mSocket, handler, rp, worker) != HandleResult::NOT_EXISTS) return true;
			return false;
		};

	if (DispatchPacketToHandler(gLogPacketHandler.get(), rp, worker)) return;

	if (DispatchPacketML<MainPeerSocket>(mSocket, this, rp) != HandleResult::NOT_EXISTS) return;

	_DEBUG_LOG(RED, L"{}", GetPacketTypeString(rp.GetPacketType()));
}

