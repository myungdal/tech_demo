// ============================================================================
// myungdal tech-demo project
// 
// Author: 안명달 (Myungdal Ahn)
// Email: mooondal@gmail.com
// GitHub: https://github.com/myungdal/tech_demo.git
// ============================================================================

import FrontServer;
import ServerEnginePacketAutoGenerated;


HandleResult FrontPacketHandlerSystem::OnPacket(MF_ACK_MC_BYPASS& rp, MAYBE_UNUSED SocketFrontToMain& socket)
{
	if (auto socketFrontFromClientPtr = socket.GetSocket(rp.GetHeader().GetRemoteSocketId(gMyAppType)))
	{
		SocketUtil::Send<NetworkPacketWriter> wp(**socketFrontFromClientPtr);
		std::copy_n(rp.Get_nestedPacket(), rp.Get_nestedPacket_size(), wp.GetPacketBufPtr());
	}

	return HandleResult::OK;
}

HandleResult FrontPacketHandlerSystem::OnPacket(DF_ACK_DC_BYPASS& rp, MAYBE_UNUSED SocketFrontToDb& socket)
{
	if (auto socketFrontFromClientPtr = socket.GetSocket(rp.GetHeader().GetRemoteSocketId(gMyAppType)))
	{
		SocketUtil::Send<NetworkPacketWriter> wp(**socketFrontFromClientPtr);
		std::copy_n(rp.Get_nestedPacket(), rp.Get_nestedPacket_size(), wp.GetPacketBufPtr());
	}

	return HandleResult::OK;
}

HandleResult FrontPacketHandlerSystem::OnPacket(GF_GC_BYPASS& rp, MAYBE_UNUSED SocketFrontToGame& socket)
{
	for (PacketSize i = 0; i < rp.Get_userIdList_size(); ++i)
	{
		UserId userId = rp.Get_userIdList()[i];

		if (FrontUserPtr frontUser = gFrontDataManager->FindUser(userId))
		{
			if (auto socketFromClient = frontUser->GetClientSocket())
			{
				// 암호화를 위해 세션 별 패킷 생성
				SocketUtil::Send<NetworkPacketWriter> wp(**socketFromClient);
				std::copy_n(rp.Get_nestedPacket(), rp.Get_nestedPacket_size(), wp.GetPacketBufPtr());
			}
		}
	}

	return HandleResult::OK;
}

HandleResult FrontPacketHandlerSystem::OnPacket(GF_GC_BYPASS_GAME& rp, MAYBE_UNUSED SocketFrontToGame& socket)
{
	gFrontDataManager->ForEachUserInGame(rp.GetHeader().GetGameId(),
		[&rp](FrontUserPtr frontUser)
		{
			if (auto socketFromClient = frontUser->GetClientSocket())
			{
				// 암호화를 위해 세션 별 패킷 생성
				SocketUtil::Send<NetworkPacketWriter> wp(**socketFromClient);
				std::copy_n(rp.Get_nestedPacket(), rp.Get_nestedPacket_size(), wp.GetPacketBufPtr());
			}
		}
	);

	return HandleResult::OK;
}

HandleResult FrontPacketHandlerSystem::OnPacket(MF_ROOM_USER_ENTER& rp, MAYBE_UNUSED SocketFrontToMain& socket)
{
	const RoomId roomId = rp.Ref_roomId();
	const UserId userId = rp.GetHeader().GetUserId();

	gFrontDataManager->RoomUserEnter(roomId, userId);

	return HandleResult::OK;
}

HandleResult FrontPacketHandlerSystem::OnPacket(MF_ROOM_USER_LEAVE& rp, MAYBE_UNUSED SocketFrontToMain& socket)
{
	const RoomId roomId = rp.Ref_roomId();
	const UserId userId = rp.GetHeader().GetUserId();

	gFrontDataManager->RoomUserLeave(roomId, userId);

	return HandleResult::OK;
}
