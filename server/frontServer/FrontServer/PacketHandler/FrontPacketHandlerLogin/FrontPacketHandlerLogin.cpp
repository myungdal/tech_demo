// ============================================================================
// myungdal tech-demo project
// 
// Author: 안명달 (Myungdal Ahn)
// Email: mooondal@gmail.com
// GitHub: https://github.com/myungdal/tech_demo.git
// ============================================================================

import FrontServer;
import ServerEnginePacketAutoGenerated;

// [WHY] FrontSocketUtil은 import FrontServer를 통해 FrontServerSocket 모듈에서 이미 export됨


HandleResult FrontPacketHandlerLogin::OnPacket(REQ_GLOBAL_NOW& rp, MAYBE_UNUSED SocketFrontFromClient& socket)
{
	if (false == gNetworkManager->HasGlobalNow())
	{
		SocketUtil::Send<ACK_GLOBAL_NOW::Writer> wp(socket, ACK, rp, Result::RETRY_LATER);
		wp.SetValues(
			rp.Get_onlySyncTime(),
			rp.Get_reqMs(), 
			0ms
		);
	}
	else if (socket.AddSyncTimeTryCnt())
	{
		SocketUtil::Send<ACK_GLOBAL_NOW::Writer> wp(socket, ACK, rp, Result::SUCCEEDED);
		wp.SetValues(
			rp.Get_onlySyncTime(),
			rp.Get_reqMs(), 
			tClock.GetGlobalNowMs()
		);
	}
	else
	{
		SocketUtil::Send<ACK_GLOBAL_NOW::Writer> wp(socket, ACK, rp, Result::TOO_MANY_CONNECTIONS);
		wp.SetValues(
			rp.Get_onlySyncTime(),
			rp.Get_reqMs(), 
			tClock.GetGlobalNowMs()
		);
	}

	return HandleResult::OK;
}

HandleResult FrontPacketHandlerLogin::OnPacket(CF_REQ_PACKET_LIST& rp, MAYBE_UNUSED SocketFrontFromClient& socket)
{
#ifdef _DEBUG
	SocketUtil::Send<FC_ACK_PACKET_LIST::Writer> wp(socket, ACK, rp, Result::SUCCEEDED);
	const int begin = static_cast<int>(PacketTypes::START) + 1;
	const int end = static_cast<int>(PacketTypes::END);
	for (int i = begin; i < end; ++i)
	{
		const PacketType packetType = static_cast<uint16_t>(i);
		const wchar_t* packetTypeString = GetPacketTypeString(packetType);
		if (packetTypeString[0] == L'\0')
			continue;

		wp.Write_packetDevDataList(
			PACKET_DEV_DATA::Writer(PARAM, TEMP_BUF,
				packetTypeString,
				packetType
			)
		);
	}
#else
	SocketUtil::Send<FC_ACK_PACKET_LIST::Writer> wp(socket, ACK, rp, Result::WRONG_APP_VERSION);
#endif

	return HandleResult::OK;
}

// 유저 로그인 요청을 받음
HandleResult FrontPacketHandlerLogin::OnPacket(CF_REQ_USER_LOGIN& rp, MAYBE_UNUSED SocketFrontFromClient& socket)
{
	Result result = Result::SUCCEEDED;

	do
	{
		const AppConfigData& myAppConfig = gFrontServerApp->GetMyAppConfig();
		if (gFrontDataManager->GetUserCount() >= _IDX(myAppConfig.mMaxConnectionCount))
		{
			// backlog 를 조정하기 때문에 이곳에 들어 올 수 없다
			result = Result::TOO_MANY_CONNECTIONS;
			break;
		}

		const AppId dbAppId = rp.GetHeader().GetAppId(AppType::DB_SERVER);

		auto dbSocket = FrontSocketUtil::GetDbSocket(dbAppId);
		if (nullptr == dbSocket)
		{
			result = Result::RETRY_LATER;
			break;
		}

		// DB서버로 유저 로그인 요청
		SocketUtil::Send<FD_REQ_USER_LOGIN::Writer> wp(**dbSocket, REQ, rp);
		wp.GetHeader().SetAppId(AppType::FRONT_SERVER, gMyAppId);
		wp.GetHeader().SetRemoteSocketId(gMyAppType, dbSocket->MakeRemoteSocketId(&socket));
		wp.SetValues(
			rp.Get_authTicket()
		);

	} while (false);

	if (Result::SUCCEEDED != result)
	{
		// 실패 응답
		SocketUtil::Send<FC_ACK_USER_LOGIN::Writer> wp(socket, ACK, rp, result);
		wp.SetValues(
			{},
			{},
			Checksum{}
		);
	}

	return HandleResult::OK;
}

HandleResult FrontPacketHandlerLogin::OnPacket(DF_ACK_USER_LOGIN& rp, MAYBE_UNUSED SocketFrontToDb& socket)
{
	auto clientSocket = socket.GetSocket(rp.GetHeader().GetRemoteSocketId(gMyAppType));
	if (nullptr == clientSocket)
		return HandleResult::OK;

	Result result = Result::SUCCEEDED;

	do
	{
		if (Result::SUCCEEDED != rp.GetHeader().GetPacketResult())
		{
			result = rp.GetHeader().GetPacketResult();
			break;
		}

		const FrontUserPtr frontUser = gFrontDataManager->InsertUser(
			rp.Get_accountUser(),
			rp.Get_user(),
			rp.GetHeader(),
			clientSocket
		);

		if (nullptr == frontUser)
		{
			result = Result::RETRY_LATER;
			break;
		}

		frontUser->SetUser(rp.Get_accountUser(), rp.Get_user());
		frontUser->SetCurrPacketHeader(rp.GetHeader());

		clientSocket->SetFrontUser(frontUser);

		SocketUtil::Send<FC_ACK_USER_LOGIN::Writer> wp(**clientSocket, ACK, rp, rp.GetHeader().GetPacketResult());
		wp.SetValues(
			rp.Get_accountUser(),
			rp.Get_user(),
			rp.Get_staticDataChecksum()
		);

	} while (false);

	if (Result::SUCCEEDED != result)
	{
		// 실패 응답
		SocketUtil::Send<FC_ACK_USER_LOGIN::Writer> wp(**clientSocket, ACK, rp, result);
		wp.SetValues(
			{},
			{},
			Checksum{}
		);
	}

	return HandleResult::OK;
}

HandleResult FrontPacketHandlerLogin::OnPacket(DF_USER_DISCONNECT& rp, MAYBE_UNUSED SocketFrontToDb& socket)
{
	const UserId userId = rp.GetHeader().GetUserId();
	if (FrontUserPtr frontUser = gFrontDataManager->FindUser(userId))
	{
		if (auto socketFromClient = frontUser->GetClientSocket())
		{
			socketFromClient->Disconnect();
		}
	}
	else
	{
		_DEBUG_LOG(RED, L"{}", GetPacketTypeString(rp.GetPacketType()));
		return HandleResult::OK;
	}

	return HandleResult::OK;
}

