// ============================================================================
// myungdal tech-demo project
// 
// Author: 안명달 (Myungdal Ahn)
// Email: mooondal@gmail.com
// GitHub: https://github.com/myungdal/tech_demo.git
// ============================================================================

import FrontServer;
import ServerEnginePacketAutoGenerated;

// [WHY] FrontSocketUtil은 import FrontServer를 통해 FrontServerSocket 모듈에서 이미 export됨


HandleResult FrontPacketHandlerGame::OnPacket(CF_REQ_GAME_CHANNEL_USER_ENTER& rp, MAYBE_UNUSED SocketFrontFromClient& socket)
{
	AppId gameAppId = rp.GetHeader().GetAppId(AppType::GAME_SERVER);
	SocketPtr<SocketFrontToGame> gameSocket = FrontSocketUtil::GetGameSocket(gameAppId);
	if (!gameSocket)
	{
		SocketUtil::Send<FC_ACK_GAME_CHANNEL_USER_ENTER::Writer> wp(socket, ACK, rp, Result::RETRY_LATER);
		return HandleResult::OK;
	}

	SocketUtil::Send<FG_REQ_GAME_CHANNEL_USER_ENTER::Writer> wp(**gameSocket, REQ);
	wp.SetHeader(rp.GetHeader());

	return HandleResult::OK;
}

HandleResult FrontPacketHandlerGame::OnPacket(GF_ACK_GAME_CHANNEL_USER_ENTER& rp, MAYBE_UNUSED SocketFrontToGame& socket)
{
	_ASSERT_CRASH(tWorkingWorker == gFrontDataManager);

	SocketPtr<SocketFrontToGame> ptr(&socket, L"GameUserEnter");
	gFrontDataManager->GameUserEnter(
		rp.GetHeader(),
		ptr
	);

	if (FrontUserPtr frontUser = gFrontDataManager->FindUser(rp.GetHeader().GetUserId()))
	{
		if (auto clientSocket = frontUser->GetClientSocket())
			SocketUtil::Send<FC_ACK_GAME_CHANNEL_USER_ENTER::Writer> wp(**clientSocket, ACK, rp, Result::SUCCEEDED);
	}
	
	return HandleResult::OK;
}

HandleResult FrontPacketHandlerGame::OnPacket(GF_GAME_CHANNEL_USER_LEAVE& rp, MAYBE_UNUSED SocketFrontToGame& socket)
{
	_ASSERT_CRASH(tWorkingWorker == gFrontDataManager);

	gFrontDataManager->GameUserLeave(
		rp.GetHeader()
	);

	return HandleResult::OK;
}

