// ============================================================================
// myungdal tech-demo project
// 
// Author: 안명달 (Myungdal Ahn)
// Email: mooondal@gmail.com
// GitHub: https://github.com/myungdal/tech_demo.git
// ============================================================================

#include "AppListManager.h"

#include "Common/Random/Mt19937Random/Mt19937Random64.h"
#include "Packet/BasePacketAutoGenerated/PACKET_COMMON.h"


AppListManager::AppListManager()
{
	mAppList.fill(nullptr);
}
WriteLock AppListManager::ClearAppInfoAll()
{	
	WriteLock lock(mLock);
	mAppList.fill(nullptr);
	for (AppIdList& appIdList : mAppIdTable)
	{
		appIdList.clear();
	}
	return std::move(lock);
}
std::pair<AppInfo*, WriteLock> AppListManager::AddAppInfo(const APP_DATA& appData)
{
	WriteLock lock(mLock);
	const size_t index = _IDX(appData.Get_appId());

	AppInfoPtr appInfo = mAppList[index];
	if (nullptr == appInfo)
		appInfo = std::make_shared<AppInfo>();

	mAppList[index] = appInfo;
	appInfo->SetData(appData);

	size_t appTypeIdx = _IDX(appData.Get_appType());

	if (mAppIdTable.size() > appTypeIdx)
	{
		AppIdList& appIdList = mAppIdTable[appTypeIdx];
		const AppId appId = appData.Get_appId();
		if (std::find(appIdList.begin(), appIdList.end(), appId) == appIdList.end())
		{
			appIdList.emplace_back(appId);
		}
	}

	return std::make_pair(appInfo.get(), std::move(lock));
}

bool AppListManager::RemoveAppInfo(AppId appId)
{
	auto [appInfo, lock] = FindAppInfo(appId);

	if (!appInfo)
		return false;

	AppType appType = appInfo->GetData().Get_appType();
	size_t appTypeIdx = static_cast<size_t>(appType);

	if (mAppIdTable.size() > appTypeIdx)
	{
		AppIdList& appIdList = mAppIdTable[appTypeIdx];

		const AppIdList::iterator it = std::remove(appIdList.begin(), appIdList.end(), appId);
		if (appIdList.end() != it)
			appIdList.erase(it);

		mAppList[appId] = nullptr;
	}

	return true;
}

std::pair<AppInfo*, ReadLock> AppListManager::FindAppInfo(AppId appId)
{
	ReadLock lock(mLock);

	if (mAppList.size() <= _IDX(appId))
		return std::make_pair(nullptr, std::move(lock));

	return std::make_pair(mAppList[appId].get(), std::move(lock));
}

std::pair<AppIdList*, ReadLock> AppListManager::GetAppIdList(AppType appType)
{
	ReadLock lock(mLock);

	if (mAppIdTable.size() <= _IDX(appType))
		return std::make_pair(nullptr, std::move(lock));

	const size_t appIdTableIndex = _IDX(appType);
	return std::make_pair(&mAppIdTable[appIdTableIndex], std::move(lock));
}

std::pair<AppList*, ReadLock> AppListManager::GetAppList()
{
	ReadLock lock(mLock);

	return std::make_pair(&mAppList, std::move(lock));
}

std::pair<AppInfo*, ReadLock> AppListManager::GetMainServerAppInfo()
{
	auto [appIdList, lock] = GetAppIdList(AppType::MAIN_SERVER);
	if (appIdList && !appIdList->empty())
	{
		const AppId appId = *appIdList->begin();

		return gAppListManager->FindAppInfo(appId);
	}

	return std::make_pair(nullptr, std::move(lock));
}

std::pair<AppInfo*, ReadLock> AppListManager::GetDbServerAppInfo(const AccountId accountId)
{
	auto [appIdList, lock] = GetAppIdList(AppType::DB_SERVER);
	if (!appIdList || appIdList->empty())
		return std::make_pair(nullptr, std::move(lock));

	const size_t size = appIdList->size();
	size_t idx = (accountId.GetData() % size);
	for (AppId appId : *appIdList)
	{
		auto [appInfo, _] = FindAppInfo(appId);
		if (appInfo)
		{
			if (idx == 0)
				return std::make_pair(appInfo, std::move(lock));

			--idx;
		}
	}

	return std::make_pair(nullptr, std::move(lock));
}

std::pair<AppInfo*, ReadLock> AppListManager::PickDbServerAppInfo()
{
	auto [appIdList, lock] = GetAppIdList(AppType::DB_SERVER);
	if (!appIdList || appIdList->empty())
		return std::make_pair(nullptr, std::move(lock));

	const size_t size = appIdList->size();
	const size_t idx = (*tRandomEngine64)(0, (size - 1));
	const AppId appId = (*appIdList)[idx];
	return FindAppInfo(appId);
}

std::pair<AppInfo*, ReadLock> AppListManager::PickBridgeServerAppInfo()
{
	auto [appIdList, lock] = GetAppIdList(AppType::BRIDGE_SERVER);
	if (!appIdList || appIdList->empty())
		return std::make_pair(nullptr, std::move(lock));
	
	const size_t size = appIdList->size();
	const size_t idx = (*tRandomEngine64)(0, (size - 1));
	const AppId appId = (*appIdList)[idx];
	return FindAppInfo(appId);
}

std::pair<AppInfo*, ReadLock> AppListManager::PickGameServerAppInfo(size_t hash)
{
	auto [appIdList, lock] = GetAppIdList(AppType::GAME_SERVER);
	if (!appIdList || appIdList->empty())
		return std::make_pair(nullptr, std::move(lock));

	const size_t size = appIdList->size();
	const size_t idx = (hash % size);
	const AppId appId = (*appIdList)[idx];
	return FindAppInfo(appId);
}
