// ============================================================================
// myungdal tech-demo project
// 
// Author: 안명달 (Myungdal Ahn)
// Email: mooondal@gmail.com
// GitHub: https://github.com/myungdal/tech_demo.git
// ============================================================================

#include "CommonShellCommandHandler.h"

#include "Packet/BasePacketAutoGenerated/PACKET_COMMON.h"

import ServerEngineNetwork;
import ServerEngineUtil;
import ServerEngineWorker;
import ServerEngineApp;


CommonShellCommandHandler::CommonShellCommandHandler()
{
	mCommandDispatcher.Register(
		L"help", L"도움말",
		std::bind(&CommonShellCommandHandler::OnCommand_help, this, std::placeholders::_1)
	);
	mCommandDispatcher.Register(
		L"appList", L"앱 목록",
		std::bind(&CommonShellCommandHandler::OnCommand_appList, this, std::placeholders::_1)
	);
	mCommandDispatcher.Register(
		L"mem", L"메모리 사용 내역",
		std::bind(&CommonShellCommandHandler::OnCommand_mem, this, std::placeholders::_1)
	);
}
std::wstring CommonShellCommandHandler::Dispatch(SocketBasePtr socket, const wchar_t* command)
{
	mSocketBaseWeakPtr = socket;
	return mCommandDispatcher.Dispatch(command);
}
std::wstring CommonShellCommandHandler::OnCommand_help(MAYBE_UNUSED ArgList& argList)
{
	std::wstring result;
	result += L"\n";
	result += L"* Common 명령:\n";
	for (const auto& [key, handler] : mCommandDispatcher.GetHandlerMap())
	{
		result += L"\t";
		result += std::get<0>(handler);
		result += L"\t";
		result += std::get<1>(handler);
		result += L"\n";
	}
	result += L"\n";
	return result;
}
std::wstring CommonShellCommandHandler::OnCommand_appList(MAYBE_UNUSED ArgList& argList)
{
	SocketBasePtr socketBasePtr = mSocketBaseWeakPtr.Lock();
	if (!socketBasePtr)
		return L"OnCommand_appList";
	const auto [appList, lock] = gAppListManager->GetAppList();
	if (!appList)
		return L"OnCommand_appList";
	
	std::wstring result = std::format(L"[{}]\n", socketBasePtr->GetSocketNameW());

	for (const AppInfoPtr& appInfo : *appList)
	{
		if (nullptr == appInfo)
			continue;

		if (appInfo->GetSocket().IsNull())
			continue;

		//result += std::format(L"\t{}\n", &appInfo->GetData()).data();

		result += std::format(L"\t{}, {}\n", appInfo->GetData().Get_appId(), appInfo->GetData().Get_appType()).data();
	}

	return result;
}

std::wstring CommonShellCommandHandler::OnCommand_mem(MAYBE_UNUSED ArgList& argList)
{
	SocketBasePtr socketBasePtr = mSocketBaseWeakPtr.Lock();
	if (!socketBasePtr)
		return L"OnCommand_mem";

	std::lock_guard<std::mutex> lock(GetUsageMeterDataMapMutex());

	std::wstring result = std::format(L"[{}]\n", socketBasePtr->GetSocketNameW());

	for (auto [_, data] : GetUsageMeterDataMap())
	{
		const std::wstring& parentName = data->mParentNameW;
		const std::wstring& className = data->mClassNameW;
		const int64_t increase = data->mIncrease;
		const int64_t decrease = data->mDecrease;
		const int64_t inUse = (increase - decrease);
		const int64_t limitation = data->mLimitation;

		result += std::format(L"\tname: {}-{}, inUse: {}({} - {}), limitation: {}\n", parentName, className, inUse, increase, decrease, limitation).data();		
	}

	return result;
}
