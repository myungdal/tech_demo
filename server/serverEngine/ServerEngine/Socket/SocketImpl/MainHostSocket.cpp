// ============================================================================
// myungdal tech-demo project
// 
// Author: 안명달 (Myungdal Ahn)
// Email: mooondal@gmail.com
// GitHub: https://github.com/myungdal/tech_demo.git
// ============================================================================

#include "MainHostSocket.h"

#include "Packet/BasePacketAutoGenerated/PACKET_COMMON.h"

import ServerEngineNetwork;
import ServerEngineUtil;
import ServerEngineWorker;
import ServerEngineApp;


MainHostSocket::MainHostSocket()
{
}
void MainHostSocket::OnConnected(bool succeed)
{
	_DEBUG_LOG(WHITE, L"[{}]", mSocket);

	mAppId.store(INVALID_APP_ID);

	__super::OnConnected(succeed);
}

void MainHostSocket::OnDisconnected()
{
	_DEBUG_LOG(WHITE, L"[{}]", mSocket);

	const AppId appId = mAppId.load();
	if(INVALID_APP_ID != appId)
	{
		MAYBE_UNUSED bool result = gAppListManager->RemoveAppInfo(mAppId);

		auto [appList, _] = gAppListManager->GetAppList();

		// 앱 데이터 제거 브로드캐스팅.
		for (const AppInfoPtr& appInfo : *appList)
		{
			if (!appInfo)
				continue;

			if (auto socket = appInfo->GetSocket())
			{
				SocketUtil::Send<APP_REMOVE::Writer> wp(**socket, NOTIFY);
				wp.SetValues(appId);
			}
		}

		mAppId.store(INVALID_APP_ID);
	}

	__super::OnDisconnected();

	OnAppRemoved(appId);
}

HandleResult MainHostSocket::OnPacket(MAYBE_UNUSED NetworkPacket& rp)
{
	_DEBUG_LOG(RED, L"{}", GetPacketTypeString(rp.GetPacketType()));

	return HandleResult::OK;
}

HandleResult MainHostSocket::OnPacket(REQ_GLOBAL_NOW& rp)
{
	SocketUtil::Send<ACK_GLOBAL_NOW::Writer> wp(*this, ACK, rp, Result::SUCCEEDED);
	wp.SetValues(
		rp.Get_onlySyncTime(),
		rp.Get_reqMs(), 
		tClock.GetGlobalNowMs()
	);

	return HandleResult::OK;
}

HandleResult MainHostSocket::OnPacket(REQ_APP_JOIN& rp)
{
	// 중복 앱의 연결을 끊고, 잠시 후 다시 시도하라고 응답.
	{
		auto [appInfo, lock] = gAppListManager->FindAppInfo(rp.Get_appData().Get_appId());
		if (appInfo)
		{
			if (auto socket = appInfo->GetSocket())
			{
				if (socket != this)
				{
					// 이런 부분이 없어야 할 것 같다, disconnect 될 때 잘 제거해 주는것이 맞는 것 같다
					// 그렇다면, 단순히 this->Disconnect(); 해야 한다......
					_DEBUG_BREAK;

					socket->Disconnect();

					SocketUtil::Send<ACK_APP_JOIN::Writer> wp(*this, ACK, rp, Result::APP_JOIN_RETRY_LATER);

					return HandleResult::OK;
				}
			}
		}
	}

	// 새로운 앱 데이터 추가.
	{
		auto [newAppInfo, lock] = gAppListManager->AddAppInfo(rp.Get_appData());
		if (!newAppInfo)
		{
			SocketUtil::Send<ACK_APP_JOIN::Writer> wp(*this, ACK, rp, Result::APP_JOIN_COUNT_OVERFLOW);
			return HandleResult::OK;
		}

		// 셋팅.
		newAppInfo->SetSocket(GetSocketPtr(), L"REQ_APP_JOIN");
		mAppId.store(newAppInfo->GetData().Get_appId());

		const auto [appList, _] = gAppListManager->GetAppList();

		// 앱 목록을 담아 성공 응답.
		{
			SocketUtil::Send<ACK_APP_JOIN::Writer> wp(*this, ACK, rp, Result::SUCCEEDED);
			for (const AppInfoPtr& appInfo : *appList)
			{
				if (!appInfo)
					continue;

				const APP_DATA& appData = appInfo->GetData();
				wp.Write_appDataList(appData);
			}
		}

		// 새로운 앱 데이터 추가 브로드캐스팅.
		for (const AppInfoPtr& appInfo : *appList)
		{
			if (!appInfo)
				continue;

			// 새로운 앱에게는 보내지 않는다.
			if (appInfo->GetData().Get_appId() == rp.Get_appData().Get_appId())
				continue;

			if (auto socket = appInfo->GetSocket())
			{
				SocketUtil::Send<APP_ADD::Writer> wp(**socket, NOTIFY);
				wp.SetHeader(rp.GetHeader());
				wp.SetValues(
					newAppInfo->GetData()
				);
			}
		}

		OnAppAdded(*newAppInfo);
	}
	
	return HandleResult::OK;
}
