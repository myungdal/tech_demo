// ============================================================================
// myungdal tech-demo project
// 
// Author: 안명달 (Myungdal Ahn)
// Email: mooondal@gmail.com
// GitHub: https://github.com/myungdal/tech_demo.git
// ============================================================================

#pragma once

#include "Packet/BasePacketAutoGenerated/PACKET_TYPE.h"

#include "ServerEngine/Worker/WorkerBase/Worker.h"


struct BotStatistics;

// 봇 통계 수집 및 모니터링 담당
// - 봇 이벤트(생성/파괴/연결/시나리오 등) 추적
// - 패킷 송수신 카운트 및 결과 통계
class BotMonitor : public Worker
{
private:
	static constexpr ClockMs PRINT_INTERVAL = 10 * 1000ms;

	using BotStatisticsList = std::vector<BotStatistics>;

	using CountArray_MC = std::array<size_t, PacketTypes::MC_PACKET_END - PacketTypes::MC_PACKET_START - 1>;
	using CountArray_CM = std::array<size_t, PacketTypes::CM_PACKET_END - PacketTypes::CM_PACKET_START - 1>;

	using CountArray_FC = std::array<size_t, PacketTypes::FC_PACKET_END - PacketTypes::FC_PACKET_START - 1>;
	using CountArray_CF = std::array<size_t, PacketTypes::CF_PACKET_END - PacketTypes::CF_PACKET_START - 1>;

	using CountArray_DC = std::array<size_t, PacketTypes::DC_PACKET_END - PacketTypes::DC_PACKET_START - 1>;
	using CountArray_CD = std::array<size_t, PacketTypes::CD_PACKET_END - PacketTypes::CD_PACKET_START - 1>;

	using CountArray_GC = std::array<size_t, PacketTypes::GC_PACKET_END - PacketTypes::GC_PACKET_START - 1>;
	using CountArray_CG = std::array<size_t, PacketTypes::CG_PACKET_END - PacketTypes::CG_PACKET_START - 1>;

	using CountArray_BC = std::array<size_t, PacketTypes::BC_PACKET_END - PacketTypes::BC_PACKET_START - 1>;
	using CountArray_CB = std::array<size_t, PacketTypes::CB_PACKET_END - PacketTypes::CB_PACKET_START - 1>;

	using ResultCountArray = std::array<size_t, _IDX(Result::MAX)>;

	BotStatisticsList mBotStatisticsList;

	CountArray_MC mCountArray_MC = { 0 };
	CountArray_CM mCountArray_CM = { 0 };

	CountArray_FC mCountArray_FC = { 0 };
	CountArray_CF mCountArray_CF = { 0 };

	CountArray_DC mCountArray_DC = { 0 };
	CountArray_CD mCountArray_CD = { 0 };

	CountArray_GC mCountArray_GC = { 0 };
	CountArray_CG mCountArray_CG = { 0 };

	CountArray_BC mCountArray_BC = { 0 };
	CountArray_CB mCountArray_CB = { 0 };

	ResultCountArray mResultCountArray = { 0 };

public:
	void Initialize(size_t maxBotCount);
	void Print_timer_async();

public:
	void OnBotEvent_async(BotEventType eventType, BotId botId, const std::wstring& sceneName, BotSceneSeq sceneSeq, ClockPoint clockPoint);
	void OnPacketRecv_async(PacketType packetType);
	void OnPacketSend_async(PacketType packetType);
	void OnPacketResult_async(Result result);

private:
	BotEventType GetDurationTarget(BotEventType eventType);
};

inline std::shared_ptr<BotMonitor> gBotMonitor = nullptr;
