// ============================================================================
// myungdal tech-demo project
// 
// Author: 안명달 (Myungdal Ahn)
// Email: mooondal@gmail.com
// GitHub: https://github.com/myungdal/tech_demo.git
// ============================================================================

import Bot;
import ServerEnginePacketAutoGenerated;


BotSceneMail::BotSceneMail(BotPtr& bot)
	: 
	BotScene(bot)
{
	mTestMailId = UuidUtil::GenerateUuid();
	RegisterSeq(this, &BotSceneMail::CD_REQ_CHEAT_CREATE_MAIL);
	RegisterSeq(this, &BotSceneMail::CD_REQ_MAIL_LIST);
	RegisterSeq(this, &BotSceneMail::CD_REQ_MAIL_READ);
	NextSeq();
}
void BotSceneMail::OnLostConnection()
{
	_DEBUG_LOG(WHITE, L"[{}][{}]", GetRawSocket(), GetBotId());
	TryChangeToReconnectScene();
}

bool BotSceneMail::OnDispatchPacket(NetworkPacket& rp)
{
	HandleResult handleResult = DispatchPacket(GetRawSocket(), this, rp);

	if (handleResult == HandleResult::NOT_EXISTS)
	{
		_DEBUG_RED;
		return true;
	}

	return (handleResult == HandleResult::OK) ? true : false;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

HandleResult BotSceneMail::OnPacket(MAYBE_UNUSED NetworkPacket& rp)
{
	HandleResult handleResult = DispatchPacketToParent<BotScene>(GetRawSocket(), this, rp);
	if (handleResult == HandleResult::NOT_EXISTS)
		_DEBUG_RED;
	return handleResult;
}

void BotSceneMail::CD_REQ_CHEAT_CREATE_MAIL()
{
	// [WHY] DBServer CheatManager에 CreateMail 로직 필요:
	// CreateMail MailId MailSid RewardSid
	const int64_t mailSid = 0;
	const int64_t rewardSid = 0;

	const int64_t mailId = mTestMailId.GetData();

	auto [cmd, _] = StringUtil::FormatStr(L"CreateMail {} {} {}", mailId, mailSid, rewardSid);

	BotSocketUtil::SendToFront<CD_REQ_CHEAT::Writer> wp(*this, REQ);
	wp.SetHeader(GetBotContext().CurrPacketHeader());
	wp.SetValues(
		*cmd
	);
}

void BotSceneMail::CD_REQ_MAIL_LIST()
{
	BotSocketUtil::SendToFront<CD_REQ_MAIL_LIST::Writer> wp(*this, REQ);
	wp.SetHeader(GetBotContext().CurrPacketHeader());
	wp.SetValues(
		INVALID_UUID,
		INVALID_UUID
	);
}

HandleResult BotSceneMail::OnPacket(DC_ACK_MAIL_LIST& rp)
{
	const Result result = rp.GetHeader().GetPacketResult();
	ReportResultAndYield(result);

	switch (result)
	{
	case Result::SUCCEEDED:
		NextSeq();
		break;
	case Result::RETRY_LATER:
		RetrySeq();
		break;
	default:
		_DEBUG_LOG(RED, L"{}", result);
		_DEBUG_RED;

		NextSeq();
		break;
	}

	return HandleResult::OK;
}

void BotSceneMail::CD_REQ_MAIL_READ()
{
	MailIdList mailIdList;
	if (INVALID_UUID != mTestMailId)
		mailIdList.emplace_back(mTestMailId);

	BotSocketUtil::SendToFront<CD_REQ_MAIL_READ::Writer> wp(*this, REQ);
	wp.SetHeader(GetBotContext().CurrPacketHeader());
	wp.SetValues(
		mailIdList.data(),
		static_cast<PacketSize>(mailIdList.size())
	);	
}

HandleResult BotSceneMail::OnPacket(DC_ACK_MAIL_READ& rp)
{
	const Result result = rp.GetHeader().GetPacketResult();
	ReportResultAndYield(result);

	switch (result)
	{
	case Result::SUCCEEDED:
		NextSeq();
		break;
	case Result::RETRY_LATER:
		RetrySeq();
		break;
	default:
		_DEBUG_LOG(RED, L"{}", result);
		_DEBUG_RED;

		NextSeq();
		break;
	}

	return HandleResult::OK;
}

