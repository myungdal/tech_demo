// ============================================================================
// myungdal tech-demo project
// 
// Author: 안명달 (Myungdal Ahn)
// Email: mooondal@gmail.com
// GitHub: https://github.com/myungdal/tech_demo.git
// ============================================================================

import MainServer;
import ServerEnginePacketAutoGenerated;


HandleResult MainPacketHandlerRoom::OnPacket(MAYBE_UNUSED FM_ROOM_USER_ENTER& rp, MAYBE_UNUSED SocketMainFromFront& socket)
{
	_ASSERT_CRASH(tWorkingWorker == gRoomListManager);

	const RoomId roomId = rp.Get_roomId();
	const RoomType roomType = rp.Get_roomType();
	const AppId appId = socket.GetAppId();
	const USER& enterUser = rp.Get_enterUser();
	if (RoomPtr mainRoomPtr = gRoomListManager->AddUserToRoom(roomId, roomType, appId, enterUser))
	{
		MainSocketUtil::BroadcastToServers<MF_ROOM_USER_ENTER::Writer> wp(AppType::FRONT_SERVER, NOTIFY);
		wp.SetValues(
			roomId,
			roomType,
			enterUser
		);
	}

	return HandleResult::OK;
}

HandleResult MainPacketHandlerRoom::OnPacket(MAYBE_UNUSED FM_ROOM_USER_LEAVE& rp, MAYBE_UNUSED SocketMainFromFront& socket)
{
	_ASSERT_CRASH(tWorkingWorker == gRoomListManager);

	const RoomId roomId = rp.Get_roomId();
	const AppId appId = socket.GetAppId();
	const UserId leaveUserId = rp.Get_leaveUserId();
	gRoomListManager->RemoveUserFromRoom(roomId, appId, leaveUserId);

	MainSocketUtil::BroadcastToServers<MF_ROOM_USER_LEAVE::Writer> wp(AppType::FRONT_SERVER, NOTIFY);
	wp.SetValues(
		roomId,
		leaveUserId
	);

	return HandleResult::OK;
}

