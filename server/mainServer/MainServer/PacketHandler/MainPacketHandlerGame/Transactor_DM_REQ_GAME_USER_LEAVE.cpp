// ============================================================================
// myungdal tech-demo project
// 
// Author: 안명달 (Myungdal Ahn)
// Email: mooondal@gmail.com
// GitHub: https://github.com/myungdal/tech_demo.git
// ============================================================================

import MainServer;
import ServerEnginePacketAutoGenerated;

#include "Transactor_DM_REQ_GAME_USER_LEAVE.h"


Transactor_DM_REQ_GAME_USER_LEAVE::Transactor_DM_REQ_GAME_USER_LEAVE(
	SocketMainFromDb& dbSocket,
	DM_REQ_GAME_USER_LEAVE& rp
)
	:
	mDbSocket(dbSocket),
	mRp(rp)
{
}
Result Transactor_DM_REQ_GAME_USER_LEAVE::OnUpdate()
{
	const UserId userId = mRp.GetHeader().GetUserId();
	const bool result = gGameListManager->RemoveUserFromGame(userId);
	if (false == result)
		return Result::RETRY_LATER;

	const GameId gameId = mRp.GetHeader().GetGameId();
	const AppId gameAppId = gGameListManager->GetGameAppId(gameId);
	auto gameSocket = MainSocketUtil::GetGameSocket(gameAppId);
	if (!gameSocket)
		return Result::RETRY_LATER;

	SocketUtil::Request<MG_REQ_GAME_USER_LEAVE::Writer> wp(**gameSocket, REQ, mRp);

	if (!wp.Wait(mRp.GetHeader(), OUT mAck))
		return Result::FATAL_ERROR;

	if (Result::SUCCEEDED != mAck->GetHeader().GetPacketResult())
		return mAck->GetHeader().GetPacketResult();

	mRp.GetHeader().SetGameId(INVALID_UUID);

	return Result::SUCCEEDED;
}

void Transactor_DM_REQ_GAME_USER_LEAVE::OnFinish()
{
	SocketUtil::Send<MD_ACK_GAME_USER_LEAVE::Writer> wp(mDbSocket, ACK, mRp, GetResult());
}

void Transactor_DM_REQ_GAME_USER_LEAVE::OnError()
{
	SocketUtil::Send<MD_ACK_GAME_USER_LEAVE::Writer> wp(mDbSocket, ACK, mRp, GetResult());
}

void Transactor_DM_REQ_GAME_USER_LEAVE::OnLog()
{

}
