// ============================================================================
// myungdal tech-demo project
// 
// Author: 안명달 (Myungdal Ahn)
// Email: mooondal@gmail.com
// GitHub: https://github.com/myungdal/tech_demo.git
// ============================================================================

import MainServer;
import ServerEnginePacketAutoGenerated;

#include "Transactor_DM_REQ_GAME_CREATE.h"

// [WHY] Game은 import MainServer를 통해 모듈에서 이미 export됨

Transactor_DM_REQ_GAME_CREATE::Transactor_DM_REQ_GAME_CREATE(
	SocketMainFromDb& dbSocket,
	DM_REQ_GAME_CREATE& rp
)
	:
	mDbSocket(dbSocket),
	mRp(rp)
{
}

Result Transactor_DM_REQ_GAME_CREATE::OnUpdate()
{
	const ServerId serverId = mRp.GetHeader().GetServerId();
	const UserId userId = mRp.GetHeader().GetUserId();
	const GameSid gameSid = mRp.Get_gameSid();

	mGamePtr = gGameListManager->CreateGame(serverId, userId, gameSid);
	if (!mGamePtr)
		return Result::FATAL_ERROR;

	const GAME& game = mGamePtr->GetGame();
	const GameId gameId = game.Get_c_game_id();
	const AppId gameAppId = gGameListManager->GetGameAppId(gameId);
	auto gameSocket = MainSocketUtil::GetGameSocket(gameAppId);
	if (!gameSocket)
		return Result::RETRY_LATER;

	SocketUtil::Request<MG_REQ_GAME_CREATE::Writer> wp(**gameSocket, REQ, mRp);
	wp.SetValues(
		game
	);

	if (!wp.Wait(mRp.GetHeader(), OUT mAck))
		return Result::RETRY_LATER;

	if (Result::SUCCEEDED != mAck->GetHeader().GetPacketResult())
		return mAck->GetHeader().GetPacketResult();

	return Result::SUCCEEDED;
}

void Transactor_DM_REQ_GAME_CREATE::OnFinish()
{
	const GAME& game = mGamePtr->GetGame();

	SocketUtil::Send<MD_ACK_GAME_CREATE::Writer> wp(mDbSocket, ACK, mRp, GetResult());
	wp.SetValues(
		game
	);
}

void Transactor_DM_REQ_GAME_CREATE::OnError()
{
	SocketUtil::Send<MD_ACK_GAME_CREATE::Writer> wp(mDbSocket, ACK, mRp, GetResult());
	wp.SetValues(
		GAME{}
	);
}

void Transactor_DM_REQ_GAME_CREATE::OnLog()
{
}
