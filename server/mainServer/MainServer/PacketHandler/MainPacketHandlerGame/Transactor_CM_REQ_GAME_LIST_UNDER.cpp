// ============================================================================
// myungdal tech-demo project
// 
// Author: 안명달 (Myungdal Ahn)
// Email: mooondal@gmail.com
// GitHub: https://github.com/myungdal/tech_demo.git
// ============================================================================

import MainServer;
import ServerEnginePacketAutoGenerated;

#include "Transactor_CM_REQ_GAME_LIST_UNDER.h"

// [WHY] Game은 import MainServer를 통해 모듈에서 이미 export됨


Transactor_CM_REQ_GAME_LIST_UNDER::Transactor_CM_REQ_GAME_LIST_UNDER(
	SocketMainFromFront& frontSocket,
	CM_REQ_GAME_LIST_UNDER& rp
)
	:
	mFrontSocket(frontSocket),
	mRp(rp)
{
}

Result Transactor_CM_REQ_GAME_LIST_UNDER::OnUpdate()
{
	return Result::SUCCEEDED;
}

void Transactor_CM_REQ_GAME_LIST_UNDER::OnFinish()
{
	const GameMap& gameMap = gGameListManager->GetGameList();
	const int64_t totalCount = static_cast<int64_t>(gameMap.size());

	MainSocketUtil::SendToClient<MC_ACK_GAME_LIST_UNDER::Writer> wp(mFrontSocket, ACK, mRp, GetResult());
	wp.SetValues(
		totalCount
	);
	// underGameId "미만"의 마지막 원소를 찾기 위해 lower_bound(>=)로 시작한 뒤 한 칸 뒤로 이동한다.
	auto it = gameMap.lower_bound(mRp.Get_underGameId());
	if ((it != gameMap.end()) && (it != gameMap.begin()))
	{
		--it; // it: underGameId 미만의 마지막 원소
	}		
	if (it != gameMap.end())
	{
		int64_t count = 0;
		while (count < MAX_COUNT_PER_GAME_LIST_PGAE)
		{
			const GamePtr& gamePtr = it->second;
			const GAME& game = gamePtr->GetGame();
			wp.Write_gameList(game); // 응답 리스트에 추가
			++count;

			if (it == gameMap.begin())
				break;

			--it;
		}
	}
}

void Transactor_CM_REQ_GAME_LIST_UNDER::OnError()
{
}

void Transactor_CM_REQ_GAME_LIST_UNDER::OnLog()
{

}
