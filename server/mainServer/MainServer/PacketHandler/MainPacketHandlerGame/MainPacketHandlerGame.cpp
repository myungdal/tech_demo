// ============================================================================
// myungdal tech-demo project
// 
// Author: 안명달 (Myungdal Ahn)
// Email: mooondal@gmail.com
// GitHub: https://github.com/myungdal/tech_demo.git
// ============================================================================

import MainServer;
import ServerEnginePacketAutoGenerated;

// [WHY] Game은 import MainServer를 통해 모듈에서 이미 export됨

// Transactor 헤더들 (모듈 export 대상 아님)
#include "MainServer/PacketHandler/MainPacketHandlerGame/Transactor_CM_REQ_GAME_LIST_UNDER.h"
#include "MainServer/PacketHandler/MainPacketHandlerGame/Transactor_CM_REQ_GAME_LIST_OVER.h"
#include "MainServer/PacketHandler/MainPacketHandlerGame/Transactor_DM_REQ_GAME_CREATE.h"
#include "MainServer/PacketHandler/MainPacketHandlerGame/Transactor_DM_REQ_GAME_USER_ENTER.h"
#include "MainServer/PacketHandler/MainPacketHandlerGame/Transactor_DM_REQ_GAME_USER_LEAVE.h"
#include "MainServer/PacketHandler/MainPacketHandlerGame/Transactor_DM_REQ_GAME_FINISH.h"


HandleResult MainPacketHandlerGame::OnPacket(MAYBE_UNUSED GM_GAME_SERVER_READY& rp, MAYBE_UNUSED SocketMainFromGame& socket)
{
	_ASSERT_CRASH(tWorkingWorker == gGameListManager);

	// Game들을 생성하라고 요청 패킷 전송.
	for (const auto [gameId, gamePtr] : gGameListManager->GetGameList())
	{
		const GAME& game = gamePtr->GetGame();
		const size_t hash = gGameListManager->GetHashFromGame(game);
		const AppId pickedAppId = MainSocketUtil::PickGameAppId(hash);

		if (socket.GetPeerAppId() != pickedAppId)
			continue;

		SocketUtil::Request<MG_REQ_GAME_LOAD::Writer> wp(socket, REQ);
		wp.SetValues(
			game
		);

		PacketHeader reqPacketHeader;
		GM_ACK_GAME_LOAD* ack = nullptr;
		if (!wp.Wait(reqPacketHeader, OUT ack))
			continue;
	}

	return HandleResult::OK;
}

HandleResult MainPacketHandlerGame::OnPacket(CM_REQ_GAME_LIST_OVER& rp, MAYBE_UNUSED SocketMainFromFront& socket)
{
	_ASSERT_CRASH(tWorkingWorker == gGameListManager);

	Transactor_CM_REQ_GAME_LIST_OVER transactor(socket, rp);
	transactor.Run();

	return HandleResult::OK;
}

HandleResult MainPacketHandlerGame::OnPacket(CM_REQ_GAME_LIST_UNDER& rp, MAYBE_UNUSED SocketMainFromFront& socket)
{
	_ASSERT_CRASH(tWorkingWorker == gGameListManager);

	Transactor_CM_REQ_GAME_LIST_UNDER transactor(socket, rp);
	transactor.Run();

	return HandleResult::OK;
}

HandleResult MainPacketHandlerGame::OnPacket(DM_REQ_GAME_CREATE& rp, MAYBE_UNUSED SocketMainFromDb& socket)
{
	_ASSERT_CRASH(tWorkingWorker == gGameListManager);

	Transactor_DM_REQ_GAME_CREATE transactor(socket, rp);
	transactor.Run();

	return HandleResult::OK;
}

HandleResult MainPacketHandlerGame::OnPacket(DM_REQ_GAME_USER_ENTER& rp, MAYBE_UNUSED SocketMainFromDb& socket)
{
	_ASSERT_CRASH(tWorkingWorker == gGameListManager);

	Transactor_DM_REQ_GAME_USER_ENTER transactor(socket, rp);
	transactor.Run();

	return HandleResult::OK;
}

HandleResult MainPacketHandlerGame::OnPacket(DM_REQ_GAME_USER_LEAVE& rp, MAYBE_UNUSED SocketMainFromDb& socket)
{
	_ASSERT_CRASH(tWorkingWorker == gGameListManager);

	Transactor_DM_REQ_GAME_USER_LEAVE transactor(socket, rp);
	transactor.Run();

	return HandleResult::OK;
}

HandleResult MainPacketHandlerGame::OnPacket(DM_REQ_GAME_FINISH& rp, MAYBE_UNUSED SocketMainFromDb& socket)
{
	_ASSERT_CRASH(tWorkingWorker == gGameListManager);

	Transactor_DM_REQ_GAME_FINISH transactor(socket, rp);
	transactor.Run();

	return HandleResult::OK;
}

