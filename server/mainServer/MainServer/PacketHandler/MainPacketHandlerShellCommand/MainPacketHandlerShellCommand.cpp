// ============================================================================
// myungdal tech-demo project
// 
// Author: 안명달 (Myungdal Ahn)
// Email: mooondal@gmail.com
// GitHub: https://github.com/myungdal/tech_demo.git
// ============================================================================

import MainServer;
import ServerEnginePacketAutoGenerated;


MainPacketHandlerShellCommand::MainPacketHandlerShellCommand()
{
	mMyShellCommandDispatcher.Register(
		L"help", L"도움말",
		std::bind(&MainPacketHandlerShellCommand::OnCommand_help, this, std::placeholders::_1)
	);
	mMyShellCommandDispatcher.Register(
		L"setTime", L"SetTime [year] [month] [day] [hour] [min] [sec]",
		std::bind(&MainPacketHandlerShellCommand::OnCommand_setTime, this, std::placeholders::_1)
	);
	mMyShellCommandDispatcher.Register(
		L"gameList", L"게임 목록",
		std::bind(&MainPacketHandlerShellCommand::OnCommand_gameList, this, std::placeholders::_1)
	);
}
std::wstring MainPacketHandlerShellCommand::OnCommand_help(MAYBE_UNUSED ArgList& argList)
{
	std::wstring result;
	result += L"\n";
	result += L"* Main 명령:\n";
	for (const auto& [key, handler]: mMyShellCommandDispatcher.GetHandlerMap())
	{
		result += L"\t";
		result += std::get<0>(handler);
		result += L"\t";
		result += std::get<1>(handler);
		result += L"\n";
	}
	result += L"\n";
	return result;
}
std::wstring MainPacketHandlerShellCommand::OnCommand_setTime(ArgList& argList)
{
	int32_t year = argList.GetInt<int32_t>(1, int32_t(1900));
	int32_t month = argList.GetInt<int32_t>(2, int32_t(1));
	int32_t day = argList.GetInt<int32_t>(3, int32_t(1));
	int32_t hour = argList.GetInt<int32_t>(4, int32_t(0));
	int32_t min = argList.GetInt<int32_t>(5, int32_t(0));
	int32_t sec = argList.GetInt<int32_t>(6, int32_t(0));

	time_t tt = TimeUtil::TT_FROM_NUM(year, month, day, hour, min, sec);
	ClockPoint clockPoint = CLOCK_POINT_FROM_TT(tt);
	ClockMs clockMs = CLOCK_MS_FROM_DR(clockPoint.time_since_epoch());

	gNetworkManager->SetupGlobalNow(clockMs);

	// 서버들에 syncTime 전파
	MainSocketUtil::BroadcastToServers<SYNC_TIME::Writer> wp(AppType::MAX, REQ);

	return L"";
}

std::wstring MainPacketHandlerShellCommand::OnCommand_gameList(MAYBE_UNUSED ArgList& argList)
{
	std::promise<std::wstring> promise;
	std::future<std::wstring> future = promise.get_future();

	WorkerManager::Run(gGameListManager, gGameListManager.get(), &GameListManager::GetGameListAsync, &promise);

	return future.get().data();
}

HandleResult MainPacketHandlerShellCommand::OnPacket(MAYBE_UNUSED REQ_SHELL_COMMAND& rp, MAYBE_UNUSED SocketMainFromShell& socket)
{
	std::wstring result = mMyShellCommandDispatcher.Dispatch(rp.Get_command());

	// 모두에게 수행하라고 전송
	const auto [appList, lock] = gAppListManager->GetAppList();
	if (appList)
	{
		for (const AppInfoPtr& appInfo : *appList)
		{
			if (!appInfo)
				continue;

			if (appInfo->GetData().Get_appType() == AppType::SHELL)
				continue;

			if (const auto peerSocket = appInfo->GetSocket())
			{
				SocketUtil::Request<REQ_SHELL_COMMAND::Writer> wp(**peerSocket, REQ, rp);
				std::copy_n(rp.GetPacketBufPtr(), rp.GetPacketSize(), wp.GetPacketBufPtr());

				ACK_SHELL_COMMAND* ack = nullptr;
				if (wp.Wait(wp.GetHeader(), OUT ack))
					result += ack->Get_result();
			}
		}
	}

	// 나도 수행.
	result += mCommonShellCommandHandler.Dispatch(socket.GetSocketPtr(), rp.Get_command());

	result += L">";

	SocketUtil::Send<ACK_SHELL_COMMAND::Writer> wp(socket, ACK, rp, Result::SUCCEEDED);
	wp.SetValues(
		result.data()
	);

	return HandleResult::OK;
}

HandleResult MainPacketHandlerShellCommand::OnPacket(MAYBE_UNUSED SHELL_NOTIFY& rp, MAYBE_UNUSED SocketMainFromDb& socket)
{
	mMyShellCommandDispatcher.Dispatch(rp.Get_command());

	// 모두에게 수행하라고 전송
	const auto [appList, lock] = gAppListManager->GetAppList();
	if (appList)
	{
		for (const AppInfoPtr& appInfo : *appList)
		{
			if (!appInfo)
				continue;

			if (appInfo->GetData().Get_appType() == AppType::SHELL)
				continue;

			if (const auto peerSocket = appInfo->GetSocket())
			{
				SocketUtil::Send<SHELL_NOTIFY::Writer> wp(**peerSocket, NOTIFY);
				std::copy_n(rp.GetPacketBufPtr(), rp.GetPacketSize(), wp.GetPacketBufPtr());
			}
		}
	}

	// 나도 수행.
	mCommonShellCommandHandler.Dispatch(socket.GetSocketPtr(), rp.Get_command());

	return HandleResult::OK;
}

HandleResult MainPacketHandlerShellCommand::OnPacket(CM_SHELL_COMMAND& rp, MAYBE_UNUSED SocketMainFromFront& socket)
{
	std::wstring result = mMyShellCommandDispatcher.Dispatch(rp.Get_command());

	// 모두에게 수행하라고 전송
	const auto [appList, lock] = gAppListManager->GetAppList();
	if (appList)
	{
		for (const AppInfoPtr& appInfo : *appList)
		{
			if (!appInfo)
				continue;

			if (appInfo->GetData().Get_appType() == AppType::SHELL)
				continue;

			if (const auto peerSocket = appInfo->GetSocket())
			{
				SocketUtil::Request<REQ_SHELL_COMMAND::Writer> wp(**peerSocket, REQ, rp);
				wp.SetValues(rp.Get_command());

				ACK_SHELL_COMMAND* ack = nullptr;
				if (wp.Wait(wp.GetHeader(), OUT ack))
					result += ack->Get_result();
			}
		}
	}

	_DEBUG_LOG(RED, L"{}", result);

	return HandleResult::OK;
}

