// ============================================================================
// myungdal tech-demo project
// 
// Author: 안명달 (Myungdal Ahn)
// Email: mooondal@gmail.com
// GitHub: https://github.com/myungdal/tech_demo.git
// ============================================================================

import MainServer;
import ServerEnginePacketAutoGenerated;

#include "Transactor_CM_REQ_ACCOUNT_USER_CREATE.h"


Transactor_CM_REQ_ACCOUNT_USER_CREATE::Transactor_CM_REQ_ACCOUNT_USER_CREATE(
	SocketMainFromFront& frontSocket,
	CM_REQ_ACCOUNT_USER_CREATE& rp
)
	:
	mFrontSocket(frontSocket),
	mRp(rp)
{
}
Result Transactor_CM_REQ_ACCOUNT_USER_CREATE::OnUpdate()
{
	AccountPtr accountPtr = nullptr;
	accountPtr = gAccountManager->FindOrCreateAccount(mRp.Get_account());
	if (accountPtr == nullptr)
		return Result::AUTH_ERROR;
	const ACCOUNT_USER* accountUser = accountPtr->CreateAccountUser(mRp.Get_userName());
	if (accountUser == nullptr)
		return Result::DB_ERROR;

	mAccountUserListPtr = &accountPtr->LoadAccountUserList();

	return Result::SUCCEEDED;
}

void Transactor_CM_REQ_ACCOUNT_USER_CREATE::OnFinish()
{
	MainSocketUtil::SendToClient<MC_ACK_ACCOUNT_USER_CREATE::Writer> wp(mFrontSocket, ACK, mRp, GetResult());
	for (const PacketKeep<ACCOUNT_USER>& accountUser : *mAccountUserListPtr)
	{
		wp.Write_accountUserList(**accountUser);
	}
}

void Transactor_CM_REQ_ACCOUNT_USER_CREATE::OnError()
{
	MainSocketUtil::SendToClient<MC_ACK_ACCOUNT_USER_CREATE::Writer> wp(mFrontSocket, ACK, mRp, GetResult());
}

void Transactor_CM_REQ_ACCOUNT_USER_CREATE::OnLog()
{

}
