// ============================================================================
// myungdal tech-demo project
// 
// Author: 안명달 (Myungdal Ahn)
// Email: mooondal@gmail.com
// GitHub: https://github.com/myungdal/tech_demo.git
// ============================================================================

import MainServer;
import ServerEnginePacketAutoGenerated;

#include "Transactor_CM_REQ_AUTH_TICKET.h"


Transactor_CM_REQ_AUTH_TICKET::Transactor_CM_REQ_AUTH_TICKET(
	SocketMainFromFront& frontSocket,
	CM_REQ_AUTH_TICKET& rp
)
	:
	mFrontSocket(frontSocket),
	mRp(rp)
{
}
Result Transactor_CM_REQ_AUTH_TICKET::OnUpdate()
{
	const ACCOUNT& rpAccount = mRp.Get_account();
	mAccountPtr = gAccountManager->FindOrCreateAccount(rpAccount);
	if (mAccountPtr == nullptr)
		return Result::AUTH_ERROR;

	_TODO("중복 로그인 처리: 동일 계정/유저의 기존 Front 세션 정리(강제 종료/세션 교체/정책 결정) 필요");

	const UserId userId = mRp.Get_userId();
	mAccountUserPtr = mAccountPtr->LoadAccountUser(userId);
	if (mAccountUserPtr == nullptr)
		return Result::AUTH_ERROR;

	const ACCOUNT& account = mAccountPtr->GetAccount();
	const AccountId accountId = account.Get_c_account_id();
	AppId dbAppId = MainSocketUtil::GetDbAppId(accountId);
	auto dbSocket = MainSocketUtil::GetDbSocket(dbAppId);
	if (nullptr == dbSocket)
		return Result::RETRY_LATER;

	// DB서버로 인증 찾기 요청.
	SocketUtil::Request<MD_REQ_AUTH_TICKET::Writer> wp(**dbSocket, REQ, mRp);
	wp.GetHeader().SetAppId(AppType::DB_SERVER, dbAppId);
	wp.GetHeader().SetDbShardIdx(account.Get_c_db_shard_idx());
	wp.GetHeader().SetAccountId(accountId);
	wp.GetHeader().SetUserId(userId);
	wp.SetValues(
		mAccountPtr->GetAuthTicket(),
		*mAccountUserPtr
	);

	if (!wp.Wait(mRp.GetHeader(), OUT mAck))
		return Result::RETRY_LATER;

	if (Result::SUCCEEDED != mAck->GetHeader().GetPacketResult())
		return mAck->GetHeader().GetPacketResult();

	return Result::SUCCEEDED;
}

void Transactor_CM_REQ_AUTH_TICKET::OnFinish()
{
	MainSocketUtil::SendToClient<MC_ACK_AUTH_TICKET::Writer> wp(mFrontSocket, ACK, mRp, GetResult());
	wp.SetValues(
		mAccountPtr->GetAuthTicket(),
		*mAccountUserPtr
	);
}

void Transactor_CM_REQ_AUTH_TICKET::OnError()
{
	MainSocketUtil::SendToClient<MC_ACK_AUTH_TICKET::Writer> wp(mFrontSocket, ACK, mRp, GetResult());
	wp.SetValues(
		{},
		{}
	);
}

void Transactor_CM_REQ_AUTH_TICKET::OnLog()
{

}
