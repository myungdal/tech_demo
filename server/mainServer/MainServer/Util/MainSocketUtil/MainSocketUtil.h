// ============================================================================
// myungdal tech-demo project
// 
// Author: 안명달 (Myungdal Ahn)
// Email: mooondal@gmail.com
// GitHub: https://github.com/myungdal/tech_demo.git
// ============================================================================

#pragma once

#include "Packet/NetworkPacketAutoGenerated/PacketFwd.h"

#include "ServerEngine/Util/SocketUtil/SocketUtil.h"
#include "ServerEngine/AppListManager/AppListManager.h"


class NetworkPacketWriter;
class SocketMainFromDb;
class SocketMainFromGame;

struct MainSocketUtil
{
	static AppId GetDbAppId(const AccountId accountId);
	static SocketPtr<SocketMainFromDb> GetDbSocket(AppId appId);
	static SocketPtr<SocketMainFromGame> GetGameSocket(AppId appId);
	static AppId PickGameAppId(size_t hash);
	static SocketPtr<SocketMainFromGame> PickGameSocket(size_t hash);

	template <typename _Packet>
	using SendToClient = SocketUtil::SendBypass<MF_ACK_MC_BYPASS::Writer, _Packet>;

	template<typename _Packet>
	class BroadcastToServers : public _Packet
	{
	protected:
		AppType mDest = AppType::MAX;

	public:
		template<typename... _Args>
		explicit BroadcastToServers(AppType dest, PacketTraitType trait, _Args&&... args)
			:
			mDest(dest),
			_Packet(trait, TEMP_BUF, std::forward<_Args>(args)...)
		{
		}

		virtual ~BroadcastToServers()
		{
			const auto [appList, lock] = gAppListManager->GetAppList();

			if (!appList)
				return;

			for (const AppInfoPtr& appInfo : *appList)
			{
				if (!appInfo)
					continue;

				// MAX 면 모두에게 보내고, 
				if (mDest != AppType::MAX)
				{					
					// 특정 AppType 아니면 제외하고,
					if (mDest != appInfo->GetData().Get_appType())
						continue;
				}

				if (const auto socket = appInfo->GetSocket())
				{
					SocketUtil::Send<NetworkPacketWriter> wp(**socket);
					std::copy_n(this->GetPacketBufPtr(), this->GetPacketSize(), wp.GetPacketBufPtr());
				}
			}
		}
	};
};
