<!-- ============================================================================
myungdal tech-demo project

Author: 안명달 (Myungdal Ahn)
Email: mooondal@gmail.com
GitHub: https://github.com/myungdal/tech_demo.git
============================================================================ -->

<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Nearest3 - 스킬 조합 시뮬레이션</title>
</head>

<body>
	<pre style="margin: 20px 50px; font-family: monospace; font-size: 12px; line-height: 1.5;">
[단축키]
  1 - 전사 100마리    2 - 궁수 100마리    3 - 힐러 100마리
  마우스 드래그 - 파동 생성

[팀 영역] 마우스 위치의 사분면으로 팀 결정
  좌상단=팀0(빨강)  좌하단=팀1(초록)  우상단=팀2(파랑)  우하단=팀3(검정)

[스킬 효과 선 색상]
  노랑=근접공격  보라=원거리공격  청록=힐
	</pre>
	<canvas id="canvas" width="512" height="512" style="margin: 50px; border:1px solid #000000;"></canvas>

	<script type="text/javascript" src="const.js"></script>
	<script type="text/javascript" src="event.js"></script>
	<script type="text/javascript" src="attribute.js"></script>
	<script type="text/javascript" src="effect.js"></script>
	<script type="text/javascript" src="skill.js"></script>
	<script type="text/javascript" src="entity.js"></script>
	<script type="text/javascript" src="grid.js"></script>
	<script type="text/javascript" src="nearest3.js"></script>

	<script type="text/javascript">
		var canvas = document.getElementById("canvas");
		var ctx = canvas.getContext("2d");
		//ctx.globalAlpha = 0.2;
		ctx.lineWidth = 1;
		var nearest3 = new Nearest3(canvas.width, canvas.height, 32);
		(function init() {
			var vertices = new Array(12 * 0);
			for (var i = vertices.length; i--;) {
				var type = i % 3;
				var team = i % 4;
				var x = 0;
				var y = 0;
				if (team == 0) {
					x = canvas.width * 0.25 * (0 + Math.random());
					y = canvas.height * 0.25 * (1 + Math.random());
				}
				else if (team == 1) {
					x = canvas.width * 0.25 * (1 + Math.random());
					y = canvas.height * 0.25 * (3 + Math.random());
				}
				else if (team == 2) {
					x = canvas.width * 0.25 * (3 + Math.random());
					y = canvas.height * 0.25 * (2 + Math.random());
				}
				else if (team == 3) {
					x = canvas.width * 0.25 * (2 + Math.random());
					y = canvas.height * 0.25 * (0 + Math.random());
				}
				if (team == 0) team = 0;
				else if (team == 1) team = 1;
				else if (team == 2) team = 2;
				else if (team == 3) team = 3;
				vertices[i] = [x, y, team, type];
			}
			nearest3.add(vertices);
		})();
		var isMouseDown = false;
		var mousePos = { x: 0, y: 0 };
		var mousePosDelta = { x: 0, y: 0 };
		function createEntity(cnt, team, type) {
			var vertices = new Array(cnt);
			if (team < 0) {
				if (mousePos.x < canvas.width / 2 && mousePos.y < canvas.height / 2) team = 0;
				else if (mousePos.x < canvas.width / 2 && mousePos.y > canvas.height / 2) team = 1;
				else if (mousePos.x > canvas.width / 2 && mousePos.y < canvas.height / 2) team = 2;
				else team = 3;
			}
			for (var i = vertices.length; i--;) {
				var x = mousePos.x;
				var y = mousePos.y;
				vertices[i] = [x, y, team, type];
			}
			nearest3.add(vertices);
		}
		canvas.addEventListener("mousedown", onMouseDown, false);
		canvas.addEventListener("mouseup", onMouseUp, false);
		canvas.addEventListener("mousemove", onMouseMove, false);
		document.addEventListener("keydown", onKeyDown, false);
		function onKeyDown(e) {
			e.preventDefault();
			e.stopPropagation();
			if (e.keyCode === 49) createEntity(100, -1, 0);
			else if (e.keyCode === 50) createEntity(100, -1, 1);
			else if (e.keyCode === 51) createEntity(100, -1, 2);
		}
		function onMouseDown(e) {
			e.preventDefault();
			e.stopPropagation();
			isMouseDown = true;
			mousePos.x = e.pageX - canvas.offsetLeft;
			mousePos.y = e.pageY - canvas.offsetTop;
			mousePosDelta.x = 0;
			mousePosDelta.y = 0;
			var type = Math.floor(Math.random() * 3);
			//createEntity(30, -1, type);
		}
		function onMouseUp(e) {
			e.preventDefault();
			e.stopPropagation();
			isMouseDown = false;
			mousePosDelta.x = 0;
			mousePosDelta.y = 0;
		}
		function onMouseMove(e) {
			if (!isMouseDown) return;
			e.preventDefault();
			e.stopPropagation();
			var x = e.pageX - canvas.offsetLeft;
			var y = e.pageY - canvas.offsetTop;
			mousePosDelta.x = x - mousePos.x;
			mousePosDelta.y = y - mousePos.y;
			mousePos.x = x;
			mousePos.y = y;
		}
		function draw() {
			var i = 0;
			console.time("nearest3.update()");
			var result = nearest3.update(mousePos.x, mousePos.y, 0.1, mousePosDelta.x, mousePosDelta.y);
			var entities = result.entities;
			var grid = result.grid;
			console.timeEnd("nearest3.update()");
			console.log(nearest3.scores[0], nearest3.scores[1], nearest3.scores[2], nearest3.scores[3]);
			ctx.clearRect(0, 0, canvas.width, canvas.height);
			var n = entities.length;

			//ctx.strokeStyle = "#000000";
			//for (var c = grid.cols; c--;) {
			//	for (var r = grid.rows; r--;) {
			//		var x = c * grid.cellSize + grid.cellSize * 0.5;
			//		var y = r * grid.cellSize + grid.cellSize * 0.5;
			//		ctx.beginPath();
			//		ctx.arc(x, y, 2, 0, Math.PI * 2, true);
			//		ctx.closePath();
			//		ctx.stroke();
			//	}
			//}

			//ctx.strokeStyle = "#333300";
			//ctx.beginPath();
			//ctx.arc(mousePos.x, mousePos.y, 4, 0, Math.PI * 2, true);
			//ctx.closePath();
			//ctx.stroke();

			//ctx.strokeStyle = "#003333";
			//for (var c = grid.cols; c--;) {
			//	for (var r = grid.rows; r--;) {
			//		var x0 = c * grid.cellSize + grid.cellSize * 0.5;
			//		var y0 = r * grid.cellSize + grid.cellSize * 0.5;
			//		var x1 = x0;
			//		var y1 = y0 + grid.cells[c][r].pressure;
			//		ctx.beginPath();
			//		ctx.moveTo(x0, y0);
			//		ctx.lineTo(x1, y1);
			//		ctx.closePath();
			//		ctx.stroke();
			//	}
			//}

			//ctx.strokeStyle = "#FF0000";
			//for (var c = grid.cols; c--;) {
			//	for (var r = grid.rows; r--;) {
			//		var x0 = c * grid.cellSize + grid.cellSize * 0.5;
			//		var y0 = r * grid.cellSize + grid.cellSize * 0.5;
			//		var x1 = x0 + grid.cells[c][r].vx0 * 10;
			//		var y1 = y0 + grid.cells[c][r].vy0 * 10;
			//		ctx.beginPath();
			//		ctx.moveTo(x0, y0);
			//		ctx.lineTo(x1, y1);
			//		ctx.closePath();
			//		ctx.stroke();
			//	}
			//}
			//ctx.strokeStyle = "#00FF00";
			//for (var c = grid.cols; c--;) {
			//	for (var r = grid.rows; r--;) {
			//		var x0 = c * grid.cellSize + grid.cellSize * 0.5;
			//		var y0 = r * grid.cellSize + grid.cellSize * 0.5;
			//		var x1 = x0 + grid.cells[c][r].vx1 * 10;
			//		var y1 = y0 + grid.cells[c][r].vy1 * 10;
			//		ctx.beginPath();
			//		ctx.moveTo(x0, y0);
			//		ctx.lineTo(x1, y1);
			//		ctx.closePath();
			//		ctx.stroke();
			//	}
			//}
			//ctx.strokeStyle = "#0000FF";
			//for (var c = grid.cols; c--;) {
			//	for (var r = grid.rows; r--;) {
			//		var x0 = c * grid.cellSize + grid.cellSize * 0.5;
			//		var y0 = r * grid.cellSize + grid.cellSize * 0.5;
			//		var x1 = x0 + grid.cells[c][r].vx2 * 10;
			//		var y1 = y0 + grid.cells[c][r].vy2 * 10;
			//		ctx.beginPath();
			//		ctx.moveTo(x0, y0);
			//		ctx.lineTo(x1, y1);
			//		ctx.closePath();
			//		ctx.stroke();
			//	}
			//}
			//ctx.strokeStyle = "#000000";
			//for (var c = grid.cols; c--;) {
			//	for (var r = grid.rows; r--;) {
			//		var x0 = c * grid.cellSize + grid.cellSize * 0.5;
			//		var y0 = r * grid.cellSize + grid.cellSize * 0.5;
			//		var x1 = x0 + grid.cells[c][r].vx3 * 10;
			//		var y1 = y0 + grid.cells[c][r].vy3 * 10;
			//		ctx.beginPath();
			//		ctx.moveTo(x0, y0);
			//		ctx.lineTo(x1, y1);
			//		ctx.closePath();
			//		ctx.stroke();
			//	}
			//}

			for (i = n; i--;) {
				ctx.beginPath();
				var a = entities[i];
				if (a.team === 0) ctx.strokeStyle = "#FF0000";
				else if (a.team === 1) ctx.strokeStyle = "#00FF00";
				else if (a.team === 2) ctx.strokeStyle = "#0000FF";
				else if (a.team === 3) ctx.strokeStyle = "#000000";
				var life = 55 + Math.floor(a.life / a.attribute.MAX_LIFE * 200);
				ctx.strokeStyle += (life <= 15) ? '0' + life.toString(16) : life.toString(16);
				if (a.type === 0) {
					ctx.rect(a.x, a.y, 4, 4);
				}
				else if (a.type === 1) {
					ctx.arc(a.x, a.y, 2, 0, Math.PI * 2, true);
				}
				else if (a.type === 2) {
					ctx.moveTo(a.x - 2, a.y);
					ctx.lineTo(a.x + 2, a.y);
					ctx.moveTo(a.x, a.y - 2);
					ctx.lineTo(a.x, a.y + 2);
				}
				ctx.closePath();
				ctx.stroke();
			}

			var j = nearest3.events.length;
			for (i = j; i--;) {
				var e = nearest3.events[i];
				if (e.type === 0) ctx.strokeStyle = "#999900";
				else if (e.type === 1) ctx.strokeStyle = "#990099";
				else if (e.type === 2) ctx.strokeStyle = "#009999";
				if (e.a.life > 0 && e.b.life > 0) {
					ctx.beginPath();
					var life = Math.floor(e.ttl / e.maxTtl * 200);
					ctx.strokeStyle += (life <= 15) ? '0' + life.toString(16) : life.toString(16);
					ctx.moveTo(e.a.x, e.a.y);
					ctx.lineTo(e.b.x, e.b.y);
					ctx.closePath();
					ctx.stroke();
				}
				--e.ttl;
				if (e.ttl <= 0)
					nearest3.events.splice(i, 1);
			}

			//ctx.strokeStyle = "#FF0000";
			//for (i = n; i--;) {
			//	ctx.beginPath();
			//	var a = entities[i];
			//	var b = a.e0;
			//	if (!b) continue;
			//	ctx.moveTo(a.x, a.y);
			//	ctx.lineTo(b.x, b.y);
			//	ctx.closePath();
			//	ctx.stroke();
			//}
			//ctx.strokeStyle = "#00FF00";
			//for (i = n; i--;) {
			//	ctx.beginPath();
			//	var a = entities[i];
			//	var b = a.e1;
			//	if (!b) continue;
			//	ctx.moveTo(a.x, a.y);
			//	ctx.lineTo(b.x, b.y);
			//	ctx.closePath();
			//	ctx.stroke();
			//}
			//ctx.strokeStyle = "#0000FF";
			//for (i = n; i--;) {
			//	ctx.beginPath();
			//	var a = entities[i];
			//	var b = a.e2;
			//	if (!b) continue;
			//	ctx.moveTo(a.x, a.y);
			//	ctx.lineTo(b.x, b.y);
			//	ctx.closePath();
			//	ctx.stroke();
			//}

			//setTimeout(draw, 0);
		}
		//draw();
		setInterval(draw, 32);
	</script>
</body>
</html>
