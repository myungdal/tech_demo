<!-- ============================================================================
myungdal tech-demo project

Author: 안명달 (Myungdal Ahn)
Email: mooondal@gmail.com
GitHub: https://github.com/myungdal/tech_demo.git
============================================================================ -->

<!DOCTYPE html>
<html>
<head>
</head>
<body>
	<canvas id="canvas" width="512" height="512" style="margin: 50px; border:1px solid #000000;"></canvas>
	<script type="text/javascript" src="const.js"></script>
	<script type="text/javascript" src="lockStep.js"></script>
	<script type="text/javascript" src="event.js"></script>
	<script type="text/javascript" src="attribute.js"></script>
	<script type="text/javascript" src="effect.js"></script>
	<script type="text/javascript" src="skill.js"></script>
	<script type="text/javascript" src="entity.js"></script>
	<script type="text/javascript" src="cell.js"></script>
	<script type="text/javascript" src="grid.js"></script>
	<script type="text/javascript" src="geometry.js"></script>
	<script type="text/javascript" src="world.js"></script>
	<script type="text/javascript">
		var canvas = document.getElementById("canvas");
		var ctx = canvas.getContext("2d");
		//ctx.globalAlpha = 0.2;
		ctx.lineWidth = 1;
		var lockStep = new LockStep(Date.now() + 1000);
		var world = new World(canvas.width, canvas.height);		
		(function init() {
			var vertices = new Array(1200);
			for (var i = vertices.length; i--;) {
				var type = 0;
				var team = i % 4;
				var x = 0;
				var y = 0;
				if (team == 0) {
					x = canvas.width * 0.25 * (0 + Math.random());
					y = canvas.height * 0.25 * (1 + Math.random());
				}
				else if (team == 1) {
					x = canvas.width * 0.25 * (1 + Math.random());
					y = canvas.height * 0.25 * (3 + Math.random());
				}
				else if (team == 2) {
					x = canvas.width * 0.25 * (3 + Math.random());
					y = canvas.height * 0.25 * (2 + Math.random());
				}
				else if (team == 3) {
					x = canvas.width * 0.25 * (2 + Math.random());
					y = canvas.height * 0.25 * (0 + Math.random());
				}
				if (team == 0) team = 0;
				else if (team == 1) team = 1;
				else if (team == 2) team = 2;
				else if (team == 3) team = 3;
				vertices[i] = [x, y, team, type];
			}
			world.add(vertices);
		})();
		var isMouseDown = false;
		var mousePos = { x: 0, y: 0 };
		var mousePosDelta = { x: 0, y: 0 };
		function createEntity(cnt, team, type) {
			var vertices = new Array(cnt);
			if (team < 0) {
				if (mousePos.x < canvas.width / 2 && mousePos.y < canvas.height / 2) team = 0;
				else if (mousePos.x < canvas.width / 2 && mousePos.y > canvas.height / 2) team = 1;
				else if (mousePos.x > canvas.width / 2 && mousePos.y < canvas.height / 2) team = 2;
				else team = 3;
			}
			for (var i = vertices.length; i--;) {
				var x = mousePos.x;
				var y = mousePos.y;
				vertices[i] = [x, y, team, type];
			}
			world.add(vertices);
		}
		canvas.addEventListener("mousedown", onMouseDown, false);
		canvas.addEventListener("mouseup", onMouseUp, false);
		canvas.addEventListener("mousemove", onMouseMove, false);
		document.addEventListener("keydown", onKeyDown, false);
		function onKeyDown(e) {
			e.preventDefault();
			e.stopPropagation();
			if (e.keyCode === 49) createEntity(100, -1, 0);
			else if (e.keyCode === 50) createEntity(100, -1, 0);
			else if (e.keyCode === 51) createEntity(100, -1, 0);
		}
		function onMouseDown(e) {
			e.preventDefault();
			e.stopPropagation();
			isMouseDown = true;
			mousePos.x = e.pageX - canvas.offsetLeft;
			mousePos.y = e.pageY - canvas.offsetTop;
			mousePosDelta.x = 0;
			mousePosDelta.y = 0;
		}
		function onMouseUp(e) {
			e.preventDefault();
			e.stopPropagation();
			isMouseDown = false;
			mousePosDelta.x = 0;
			mousePosDelta.y = 0;
		}
		function onMouseMove(e) {
			if (!isMouseDown) return;
			e.preventDefault();
			e.stopPropagation();
			var x = e.pageX - canvas.offsetLeft;
			var y = e.pageY - canvas.offsetTop;
			mousePosDelta.x = x - mousePos.x;
			mousePosDelta.y = y - mousePos.y;
			mousePos.x = x;
			mousePos.y = y;
		}
		ctx.fillStyle = "#000000";
		ctx.beginPath();
		ctx.rect(0, 0, canvas.width, canvas.height);
		ctx.closePath();
		ctx.fill();
		function draw() {
			var stepCnt = lockStep.getStepCntForNow();
			if(stepCnt <= 0) return;
			var i = 0;
			for(i = 0; i < stepCnt; ++i) {
				console.time("world.update()");
				world.update(mousePos.x, mousePos.y, mousePosDelta.x, mousePosDelta.y);
				var entities = world.entities;
				console.timeEnd("world.update()");
				console.log(world.scores[0], world.scores[1], world.scores[2], world.scores[3]);			
			}
			//ctx.clearRect(0, 0, canvas.width, canvas.height);
			ctx.fillStyle = "#00000022";
			ctx.globalCompositeOperation = 'darker';
			ctx.beginPath();
			ctx.rect(0, 0, canvas.width, canvas.height);
			ctx.closePath();
			ctx.fill();
			ctx.globalCompositeOperation = 'darker';
			var n = entities.length;
			for (i = n; i--;) {
				ctx.beginPath();
				var a = entities[i];
				if (a.team === 0) ctx.strokeStyle = "#FF0000";
				else if (a.team === 1) ctx.strokeStyle = "#00FF00";
				else if (a.team === 2) ctx.strokeStyle = "#0000FF";
				else if (a.team === 3) ctx.strokeStyle = "#FFFFFF";
				var life = 50 + Math.floor(a.life / a.attribute.MAX_LIFE * 150);
				ctx.strokeStyle += (life <= 15) ? '0' + life.toString(16) : life.toString(16);
				//ctx.arc(a.x, a.y, 5, 0, Math.PI * 2, true);
				//ctx.rect(a.x, a.y, 1, 1);
				ctx.moveTo(a.x, a.y);
				ctx.lineTo(a.x + a.vx * 3 + Math.random() - 0.5, a.y + a.vy * 3 + Math.random() - 0.5);
				ctx.closePath();
				//ctx.fill();
				ctx.stroke();
			}
			//setTimeout(draw, 0);
		}
		//draw();
		setInterval(draw, 10);
	</script>
</body>
</html>
