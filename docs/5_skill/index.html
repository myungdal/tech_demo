<!-- ============================================================================
myungdal tech-demo project

Author: 안명달 (Myungdal Ahn)
Email: mooondal@gmail.com
GitHub: https://github.com/myungdal/tech_demo.git
============================================================================ -->

<!DOCTYPE html>
<html>
<head>
</head>
<body>
	<canvas id="canvas" width="512" height="512" style="margin: 50px; border:1px solid #000000;"></canvas>
	<script type="text/javascript" src="const.js"></script>
	<script type="text/javascript" src="lockStep.js"></script>	
	<script type="text/javascript" src="event.js"></script>
	<script type="text/javascript" src="attribute.js"></script>
	<script type="text/javascript" src="effect.js"></script>
	<script type="text/javascript" src="skill.js"></script>
	<script type="text/javascript" src="entity.js"></script>
	<script type="text/javascript" src="geometry.js"></script>
	<script type="text/javascript" src="world.js"></script>
	<script type="text/javascript">
		var canvas = document.getElementById("canvas");
		var ctx = canvas.getContext("2d");
		//ctx.globalAlpha = 0.2;
		ctx.lineWidth = 1;
		var lockStep = new LockStep(Date.now() + 1000);
		var world = new World(canvas.width, canvas.height);		
		(function init() {
			var vertices = new Array(12 * 50);
			for (var i = vertices.length; i--;) {
				var type = i % 3;
				var team = i % 4;
				var x = 0;
				var y = 0;
				if (team == 0) {
					x = canvas.width * 0.25 * (0 + Math.random());
					y = canvas.height * 0.25 * (1 + Math.random());
				}
				else if (team == 1) {
					x = canvas.width * 0.25 * (1 + Math.random());
					y = canvas.height * 0.25 * (3 + Math.random());
				}
				else if (team == 2) {
					x = canvas.width * 0.25 * (3 + Math.random());
					y = canvas.height * 0.25 * (2 + Math.random());
				}
				else if (team == 3) {
					x = canvas.width * 0.25 * (2 + Math.random());
					y = canvas.height * 0.25 * (0 + Math.random());
				}
				if (team == 0) team = 0;
				else if (team == 1) team = 1;
				else if (team == 2) team = 2;
				else if (team == 3) team = 3;
				vertices[i] = [x, y, team, type];
			}
			world.add(vertices);
		})();
		var isMouseDown = false;
		var mousePos = { x: 0, y: 0 };
		var mousePosDelta = { x: 0, y: 0 };
		function createEntity(cnt, team, type) {
			var vertices = new Array(cnt);
			if (team < 0) {
				if (mousePos.x < canvas.width / 2 && mousePos.y < canvas.height / 2) team = 0;
				else if (mousePos.x < canvas.width / 2 && mousePos.y > canvas.height / 2) team = 1;
				else if (mousePos.x > canvas.width / 2 && mousePos.y < canvas.height / 2) team = 2;
				else team = 3;
			}
			for (var i = vertices.length; i--;) {
				var x = mousePos.x;
				var y = mousePos.y;
				vertices[i] = [x, y, team, type];
			}
			world.add(vertices);
		}
		canvas.addEventListener("mousedown", onMouseDown, false);
		canvas.addEventListener("mouseup", onMouseUp, false);
		canvas.addEventListener("mousemove", onMouseMove, false);
		document.addEventListener("keydown", onKeyDown, false);
		function onKeyDown(e) {
			e.preventDefault();
			e.stopPropagation();
			if (e.keyCode === 49) createEntity(1, -1, 0);
			else if (e.keyCode === 50) createEntity(1, -1, 1);
			else if (e.keyCode === 51) createEntity(1, -1, 2);
		}
		function onMouseDown(e) {
			e.preventDefault();
			e.stopPropagation();
			isMouseDown = true;
			mousePos.x = e.pageX - canvas.offsetLeft;
			mousePos.y = e.pageY - canvas.offsetTop;
			mousePosDelta.x = 0;
			mousePosDelta.y = 0;
		}
		function onMouseUp(e) {
			e.preventDefault();
			e.stopPropagation();
			isMouseDown = false;
			mousePosDelta.x = 0;
			mousePosDelta.y = 0;
		}
		function onMouseMove(e) {
			if (!isMouseDown) return;
			e.preventDefault();
			e.stopPropagation();
			var x = e.pageX - canvas.offsetLeft;
			var y = e.pageY - canvas.offsetTop;
			mousePosDelta.x = x - mousePos.x;
			mousePosDelta.y = y - mousePos.y;
			mousePos.x = x;
			mousePos.y = y;
		}
		function draw() {
			var stepCnt = lockStep.getStepCntForNow();
			if(stepCnt <= 0) return;
			var i = 0;
			for(i = 0; i < stepCnt; ++i) {
				console.time("world.update()");
				world.update(mousePos.x, mousePos.y, mousePosDelta.x, mousePosDelta.y);
				var entities = world.entities;
				console.timeEnd("world.update()");
				console.log(world.scores[0], world.scores[1], world.scores[2], world.scores[3]);
			}
			ctx.clearRect(0, 0, canvas.width, canvas.height);
			var n = entities.length;
			for (i = n; i--;) {
				ctx.beginPath();
				var a = entities[i];
				if (a.team === 0) ctx.strokeStyle = "#FF0000";
				else if (a.team === 1) ctx.strokeStyle = "#00FF00";
				else if (a.team === 2) ctx.strokeStyle = "#0000FF";
				else if (a.team === 3) ctx.strokeStyle = "#000000";
				var life = 55 + Math.floor(a.life / a.attribute.MAX_LIFE * 200);
				ctx.strokeStyle += (life <= 15) ? '0' + life.toString(16) : life.toString(16);
				if (a.type === 0) {
					ctx.rect(a.x, a.y, 4, 4);
				}
				else if (a.type === 1) {
					ctx.arc(a.x, a.y, 2, 0, Math.PI * 2, true);
				}
				else if (a.type === 2) {
					ctx.moveTo(a.x - 2, a.y);
					ctx.lineTo(a.x + 2, a.y);
					ctx.moveTo(a.x, a.y - 2);
					ctx.lineTo(a.x, a.y + 2);
				}
				ctx.closePath();
				ctx.stroke();
			}
			var j = world.events.length;
			for (i = j; i--;) {
				var e = world.events[i];
				if (e.type === 0) ctx.strokeStyle = "#999900";
				else if (e.type === 1) ctx.strokeStyle = "#990099";
				else if (e.type === 2) ctx.strokeStyle = "#009999";
				if (e.a && e.b) {
					if (e.a.life > 0 && e.b.life > 0) {
						ctx.beginPath();
						var life = Math.floor(e.life / e.max_life * 200);
						ctx.strokeStyle += (life <= 15) ? '0' + life.toString(16) : life.toString(16);
						ctx.moveTo(e.a.x, e.a.y);
						ctx.lineTo(e.b.x, e.b.y);
						ctx.closePath();
						ctx.stroke();
					}
				}
				else {
					ctx.beginPath();
					var life = Math.floor(e.life / e.max_life * 200);
					ctx.strokeStyle += (life <= 15) ? '0' + life.toString(16) : life.toString(16);
					ctx.moveTo(e.ax, e.ay);
					ctx.lineTo(e.bx, e.by);
					ctx.closePath();
					ctx.stroke();
				}
			}
			//setTimeout(draw, 0);
		}
		//draw();
		setInterval(draw, 10);
	</script>
</body>
</html>
