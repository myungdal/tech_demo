# 최적화 & 테스트 - 버그 수정 인수인계 문서

> **마지막 업데이트**: 2026-01-14
> **상태**: 진행 중 (빌드 검증 완료, 테스트 실행 대기)

---

## 현재 세션 요약

### 완료된 버그 수정 (총 14건)

#### 이전 세션 수정 (7건)
| # | 파일 | 수정 내용 |
|---|------|-----------|
| 1 | `server/serverEngine/.../SafeMap.h` | `Find()` thread-safe + 값 복사 반환 |
| 2 | `server/serverEngine/.../SocketBase.cpp` | `FlushSend()` deadlock 수정 |
| 3 | `server/serverEngine/.../SocketPtr.h` | 자기대입/ref leak 수정 |
| 4 | `client/.../Common/Key/StringKey/StringKey.h` | hash 함수 수정 |
| 5 | `client/.../MmoSync/WorldManager/WorldManager.cpp` | `CreateWorldUser` null 체크 추가 |
| 6 | `client/.../Common/FlowControlScript/VirtualMachine.cpp` | division by zero 수정 |
| 7 | `client/.../MmoSync/Grid/GridLod.h` | `Build()` 시작에 `mLodTable.clear()` 추가 |

#### 현재 세션 수정 (11건)
| # | 파일 | 수정 내용 |
|---|------|-----------|
| 1 | `server/serverEngine/.../DbConnectionPool.cpp` | `PushConn` 슬롯 충돌 시 빈 슬롯 탐색 |
| 2 | `server/serverEngine/.../AppListManager.cpp` | `RemoveAppInfo` bounds check + 인덱스 매크로 일관성 |
| 3 | `server/serverEngine/.../PeerSocket.cpp` | 핸드셰이크 패킷 크기 검증 추가 |
| 4 | `server/serverEngine/.../HostSocket.cpp` | 핸드셰이크 패킷 크기 검증 추가 |
| 5 | `server/serverEngine/.../HttpClient.cpp` | 실패 시 `Stop()` 호출로 리소스 정리 |
| 6 | `server/serverEngine/.../LogWriterFile.cpp` | 디렉토리 존재 여부 검사 추가 |
| 7 | `server/mainServer/.../AccountStore.cpp:216` | Map erase 시 이전 토큰 사용 |
| 8 | `client/.../Common/Serializer/Deserializer.cpp` | `ReadStringKey` 버퍼 범위 체크 |
| 9 | `client/.../MmoSync/GameInstance/GameInstance.cpp:199` | for 루프 내 `return` -> `continue` |
| 10 | `server/shell/.../ShellMcpManager.cpp` | socket 실패 시 리소스 정리 |
| 11 | `server/serverEngine/.../AppListManager.cpp:75` | 인덱스 매크로 일관성 |

#### 이번 세션 추가 수정 (3건)
| # | 파일 | 수정 내용 |
|---|------|-----------|
| 12 | `server/mainServer/.../GameListManager.cpp` | `result =` -> `result +=` (문자열 누적 버그) |
| 13 | `server/dbServer/.../ItemUtil.cpp:161` | `increasement` 계산 오류 수정 |
| 14 | `server/serverEngine/.../AppListManager.cpp:88` | `mAppList[appId]` -> `mAppList[_IDX(appId)]` |

---

## 빌드 상태

| 빌드 | 상태 | 비고 |
|------|------|------|
| Server Debug | ✅ 성공 | 경고 0, 오류 0 |
| Server Release | ✅ 성공 | |
| Client | ✅ 성공 | `build_all.bat`에 포함 |

---

## 테스트 상태

### TestUserCacheDiff 테스트 활성화됨

**파일**: `server/test/Test/App/main.cpp`

```cpp
// TestTimeStepJitter 주석 처리됨 (GUI 블로킹 방지)
// TestUserCacheDiff 활성화됨
{
    std::shared_ptr<TestAppBase> testApp = std::make_shared<TestUserCacheDiff>(appArg);
    testApp->ResumeWorker();
    testApp->Run();
    testApp->SuspendWorker();
}
```

### 테스트 실행 방법

```batch
# 빌드
cd C:\dev\nearest3
build_server.bat

# 테스트 실행 (인터랙티브 - Enter 입력으로 종료)
C:\dev\nearest3\Build\Debug\19_test\19_test.exe
```

**주의**: 테스트는 `std::wcin` 기반 인터랙티브 루프이므로:
- 콘솔에서 직접 실행 필요
- Enter 키 입력으로 종료
- 파이프 입력 (`echo | test.exe`) 불안정

### 예상 출력
```
=== UserCacheDiff / TrimInventory Test Start ===

[PASS] TrimInventory condition (0 >= quantity)
[PASS] FindItemByItemSid skips 0-quantity items

=== Result Summary ===
Pass: 2, Fail: 0
=== UserCacheDiff / TrimInventory Test Complete ===
```

---

## 다음 작업 (TODO)

### 1. 테스트 실행 및 검증
- [ ] 콘솔에서 `19_test.exe` 직접 실행
- [ ] 테스트 결과 확인 (Pass/Fail)
- [ ] 실패 시 원인 분석

### 2. 추가 버그 탐색 (선택)
- 코드베이스 추가 분석
- 잠재적 버그 패턴 검색

### 3. main.cpp 원복 (완료 후)
```cpp
// TestTimeStepJitter 다시 활성화
// TestUserCacheDiff 주석 처리
```

---

## 프로젝트 규칙 (MUST)

### 파일 인코딩
- **UTF-8 with BOM**
- **CRLF line endings**
- **Tab indentation**

인코딩 수정 스크립트:
```powershell
powershell -ExecutionPolicy Bypass -File "C:\dev\nearest3\power_shell\check_encoding_full.ps1" -FixMode
```

### 빌드 명령어
```batch
# 전체 빌드 (Lock 파일 기반 동시 빌드 방지)
build_all.bat

# 서버만
build_server.bat

# 클라이언트만
build_client_development_editor.bat
```

### 자동 생성 파일
- `autoGenerated` 폴더/파일명 포함된 파일 **직접 수정 금지**
- 수정 필요 시: `resource/*.xlsx`, `resource/db/*.sql` 수정 후 재생성

---

## 관련 파일 경로

### 수정된 파일 전체 목록
```
server/serverEngine/ServerEngine/Db/DbConnection/DbConnectionPool.cpp
server/serverEngine/ServerEngine/AppListManager/AppListManager.cpp
server/serverEngine/ServerEngine/Socket/SocketImpl/PeerSocket.cpp
server/serverEngine/ServerEngine/Socket/SocketImpl/HostSocket.cpp
server/serverEngine/ServerEngine/Http/HttpClient.cpp
server/serverEngine/ServerEngine/Log/LogInternal/LogWriterFile.cpp
server/serverEngine/ServerEngine/Util/SafeMap/SafeMap.h
server/serverEngine/ServerEngine/Socket/SocketBase/SocketBase.cpp
server/serverEngine/ServerEngine/Socket/SocketPtr/SocketPtr.h
server/mainServer/MainServer/AccountManager/AccountStore.cpp
server/mainServer/MainServer/GameListManager/GameListManager.cpp
server/dbServer/DbServer/Util/ItemUtil/ItemUtil.cpp
server/shell/Shell/ShellMcpManager/ShellMcpManager.cpp
server/test/Test/App/main.cpp
client/Client/Source/Common/Private/Common/Serializer/Deserializer.cpp
client/Client/Source/Common/Private/Common/Key/StringKey/StringKey.h
client/Client/Source/Common/Private/Common/FlowControlScript/VirtualMachine.cpp
client/Client/Source/MmoSync/Private/MmoSync/WorldManager/WorldManager.cpp
client/Client/Source/MmoSync/Private/MmoSync/GameInstance/GameInstance.cpp
client/Client/Source/MmoSync/Private/MmoSync/Grid/GridLod.h
```

### 테스트 파일
```
server/test/Test/App/main.cpp
server/test/Test/TestUserCacheDiff/TestUserCacheDiff.cpp
server/test/Test/TestUserCacheDiff/TestUserCacheDiff.h
```

---

## 완료 기준

- [ ] 모든 수정 사항 빌드 성공 ✅
- [ ] TestUserCacheDiff 테스트 통과 (수동 확인 필요)
- [ ] main.cpp 원복 (TestTimeStepJitter 복원)
- [ ] git commit (사용자 요청 시)

---

## 참고

### ItemUtil.cpp 수정 상세

**버그**: `increasement` 계산 오류
```cpp
// Before (버그)
if (sum > maxItemQuantity)
{
    itemQuantity = (sum - maxItemQuantity);
    increasement = (maxItemQuantity - increasement);  // 잘못된 계산!
    sum = maxItemQuantity;
}

// After (수정)
if (sum > maxItemQuantity)
{
    itemQuantity = (sum - maxItemQuantity);
    increasement = (maxItemQuantity - original);  // 올바른 계산
    sum = maxItemQuantity;
}
```

**예시**:
- `original = 80`, `increasement = 100`, `maxItemQuantity = 99`
- `sum = 80 + 100 = 180` (초과)
- 버그: `increasement = 99 - 100 = -1` ❌
- 수정: `increasement = 99 - 80 = 19` ✅
