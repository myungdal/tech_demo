# 테크팀 코딩파트 - 인수인계 문서

> **마지막 업데이트**: 2026-01-14
> **담당 업무**: 게임서버선택 기능 구현
> **상태**: ✅ 대부분 구현 완료, 서버 측 수정 1건 필요

---

## 현재 세션 요약

### 진행 상황
- [x] ai_design_team 기획문서 검토 완료
- [x] mainServer 코드 분석 완료 (서버 목록 관리 구조 파악)
- [x] 클라이언트 코드 분석 완료 (로그인 플로우, UI)
- [x] **게임서버선택_계획.md 작성 완료**
- [ ] 서버 측 수정 1건 (ServerId 저장)

### 확정된 사항

| 항목 | 결정 | 비고 |
|------|------|------|
| 서버 선택 횟수 | **계정당 1회** | 다른 서버에 새 캐릭터 생성 불가 |
| 최근 서버 기억 | **자동 선택** | 로컬 저장소에 저장 후 자동 선택 |
| 서버 정보 출처 | **mainServer의 ServerListManager** | DB `t_server` 테이블에서 로드 |

---

## 분석 결과 요약

### 구현 완료 ✅

| 구성요소 | 위치 | 상태 |
|----------|------|------|
| DB 테이블 `t_server` | `resource/db/main/table/t_server.sql` | ✅ |
| DB 테이블 `t_account_user` | `resource/db/main/table/t_account_user.sql` | ✅ |
| 서버 목록 관리 | `ServerListManager` | ✅ |
| 서버 목록 조회 패킷 | `CM_REQ_SERVER_LIST` / `MC_ACK_SERVER_LIST` | ✅ |
| 캐릭터 생성 패킷 | `CM_REQ_ACCOUNT_USER_CREATE` / `MC_ACK_ACCOUNT_USER_CREATE` | ✅ |
| **클라이언트 서버 선택 UI** | `ServerListWidgetBase` | ✅ |
| **클라이언트 이름 입력 UI** | `UserNamePopupWidgetBase` | ✅ |
| **클라이언트 로그인 플로우** | `ClientPacketFlowLogin` | ✅ |
| Bot 로그인 플로우 | `BotSceneLogin` | ✅ |

### 수정 필요 ⚠️ (1건)

| 구성요소 | 문제점 | 우선순위 |
|----------|--------|:---:|
| `Account::CreateAccountUser` | **ServerId가 저장되지 않음** (`INVALID_SERVER_ID` 고정) | 높음 |

---

## 클라이언트 구현 상세

### 로그인 플로우 (ClientPacketFlowLogin.cpp)

```
1. REQ_GLOBAL_NOW           → 서버 시간 동기화
2. CF_REQ_PACKET_LIST       → 패킷 타입 매핑 (개발용)
3. CM_REQ_SERVER_LIST       → 서버 목록 조회
4. CM_REQ_ACCOUNT_USER_LIST → 계정의 캐릭터 목록 조회
   ├─ 캐릭터 없음 → 서버 선택 팝업 → 이름 입력 팝업 → 캐릭터 생성
   └─ 캐릭터 있음 → 인증 티켓 발급으로 바로 진행
5. CM_REQ_ACCOUNT_USER_CREATE → 캐릭터 생성 (서버 + 이름)
6. CM_REQ_AUTH_TICKET       → 인증 티켓 발급
7. CF_REQ_USER_LOGIN        → 로그인
```

### UI 위젯

| 위젯 | 위치 | 기능 |
|------|------|------|
| `ServerListWidgetBase` | `Widget/ServerListPopup/` | 서버 목록 표시, 선택 |
| `UserNamePopupWidgetBase` | `Widget/UserNamePopup/` | 이름 입력 |

---

## 발견된 문제점 및 수정 계획

### 서버 측: ServerId 미저장

**문제**:
- 클라이언트가 `PacketHeader`에 `ServerId`를 설정해서 보내지만
- 서버 `Account::CreateAccountUser()`에서 사용하지 않고 `INVALID_SERVER_ID`로 고정
- 결과: `t_account_user.c_server_id`가 항상 0

**수정 파일**:

| 파일 | 수정 내용 |
|------|----------|
| `Account.h` | `CreateAccountUser` 시그니처 변경 |
| `Account.cpp` | `serverId` 파라미터 사용 |
| `Transactor_CM_REQ_ACCOUNT_USER_CREATE.cpp` | `GetHeader().GetServerId()` 전달 |

**예상 소요**: 0.5일

---

## 다음 작업 (TODO)

### 필수
- [ ] **ServerId 저장 수정** (서버 측 3개 파일)

### 선택 (추후)
- [ ] 서버 상태별 색상 표시
- [ ] 혼잡도 실시간 갱신

---

## 관련 파일 경로

### 클라이언트 코드
```
client/Client/Source/Client/Private/ClientPacketFlow/Login/ClientPacketFlowLogin.cpp
client/Client/Source/Client/Private/Widget/ServerListPopup/
client/Client/Source/Client/Private/Widget/UserNamePopup/
```

### 서버 코드 (수정 대상)
```
server/mainServer/MainServer/AccountManager/Account.h
server/mainServer/MainServer/AccountManager/Account.cpp
server/mainServer/MainServer/PacketHandler/MainPacketHandlerAuth/Transactor_CM_REQ_ACCOUNT_USER_CREATE.cpp
```

### 상세 계획
```
ai_tech_team/게임서버선택/게임서버선택_계획.md
```

---

## 프로젝트 규칙 (MUST)

### 파일 인코딩
- **UTF-8 with BOM**
- **CRLF line endings**
- **Tab indentation**

### 빌드 명령어
```batch
# 전체 빌드
build_all.bat

# 서버만
build_server.bat

# 클라이언트만
build_client_development_editor.bat
```

### 자동 생성 파일
- `autoGenerated` 폴더/파일명 포함된 파일 **직접 수정 금지**
- 패킷 정의: `resource/packet.xlsx` 수정 후 `bat/generate_all.bat`
