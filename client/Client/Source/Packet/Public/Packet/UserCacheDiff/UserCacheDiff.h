// ============================================================================
// myungdal tech-demo project
// 
// Author: 안명달 (Myungdal Ahn)
// Email: mooondal@gmail.com
// GitHub: https://github.com/myungdal/tech_demo.git
// ============================================================================

#pragma once

#include "Packet/BasePacketAutoGenerated/PACKET_COMMON.h"


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// UserCacheDiff
// 사용자 캐시의 변경 사항을 추적하고 관리하는 클래스입니다.
// Checkout/Rollback/Commit 패턴으로 트랜잭션 처리를 지원합니다.
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

class UserCacheAccessor;

class PACKET_API UserCacheDiff
{
private:
	const std::shared_ptr<UserCacheAccessor> mUserCacheAccessor;

private:
	using ItemQuantityMap = std::unordered_map<ItemId, ItemQuantity>;

	UserExp mUserExp = 0;
	ItemQuantityMap mItemQuantityMap;

private:
	std::vector<ItemId> mModifiedItemIdList;
	std::vector<ItemQuantity> mModifiedItemQuantityList;
	std::deque<std::pair<ItemId, UserItemRowPtr>> mNewItemList;

private:
	bool mCheckOuted = false;

public:
	explicit UserCacheDiff(const std::shared_ptr<UserCacheAccessor>& userCache);

public:
	void Checkout();
	void Rollback();
	void Commit(OUT USER_CACHE_DIFF::Writer& diff);
};
