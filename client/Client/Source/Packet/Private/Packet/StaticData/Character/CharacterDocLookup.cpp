// ============================================================================
// myungdal tech-demo project
// 
// Author: 안명달 (Myungdal Ahn)
// Email: mooondal@gmail.com
// GitHub: https://github.com/myungdal/tech_demo.git
// ============================================================================

#include "Packet/StaticData/Character/CharacterDocLookup.h"

#include "Packet/BasePacketAutoGenerated/PACKET_COMMON.h"
#include "Packet/StaticDataAccessor/StaticDataAccessor.h"
#include "Packet/StaticDataCatalog/StaticDataCatalog.h"
#include "Packet/StaticData/Character/CharacterDoc.h"
#include "Packet/StaticData/CharacterSkill/CharacterSkillDocLookup.h"
#include "Packet/StaticData/Item/ItemDocLookup.h"


CharacterDocLookup::~CharacterDocLookup()
{
	Clear();
}
void CharacterDocLookup::Clear()
{
	for (auto& [_, doc] : mCharacterDocMap)
	{
		_DELETE(doc);
	}
	mCharacterDocMap.clear();
}

void CharacterDocLookup::Load()
{
	for (auto& it : gStaticDataCatalog->GetList<STATIC_CHARACTER>())
	{
		auto key = it->Get_c_character_item_sid();
		auto found = mCharacterDocMap.find(key);
		CharacterDoc* doc = (mCharacterDocMap.end() != found) ? found->second : _NEW<CharacterDoc>();
		doc->mStaticCharacter = *it;
		mCharacterDocMap.emplace(key, doc);		
	}
}

void CharacterDocLookup::Link()
{
	{
		const std::shared_ptr<ItemDocLookup> view = gStaticDataAccessor->Get<ItemDocLookup>();
		for (auto& [sid, doc] : mCharacterDocMap)
			doc->mItemDoc = view->Find(sid);
	}
	{
		const std::shared_ptr<CharacterSkillDocLookup> view = gStaticDataAccessor->Get<CharacterSkillDocLookup>();
		for (auto& [sid, doc] : mCharacterDocMap)
			doc->mCharacterSkillDoc = view->Find(sid);
	}

}

const CharacterDoc* CharacterDocLookup::Find(ItemSid characterItemSid) const
{
	const auto it = mCharacterDocMap.find(characterItemSid);

	if (mCharacterDocMap.end() == it)
	{
		// 허용
		//_DEBUG_BREAK;
		//_DEBUG_RED;
		return nullptr;
	}

	return it->second;
}
