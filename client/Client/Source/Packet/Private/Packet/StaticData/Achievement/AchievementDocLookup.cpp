// ============================================================================
// myungdal tech-demo project
// 
// Author: 안명달 (Myungdal Ahn)
// Email: mooondal@gmail.com
// GitHub: https://github.com/myungdal/tech_demo.git
// ============================================================================

#include "Packet/StaticData/Achievement/AchievementDocLookup.h"

#include "Packet/BasePacketAutoGenerated/PACKET_COMMON.h"
#include "Packet/StaticDataAccessor/StaticDataAccessor.h"
#include "Packet/StaticDataCatalog/StaticDataCatalog.h"
#include "Packet/StaticData/Achievement/AchievementDoc.h"
#include "Packet/StaticData/Reward/RewardDocLookup.h"


AchievementDocLookup::~AchievementDocLookup()
{
	Clear();
}
void AchievementDocLookup::Clear()
{
	for (auto& [_, doc] : mAchievementDocMap)
	{
		_DELETE(doc);
	}
	mAchievementDocMap.clear();
}

void AchievementDocLookup::Load()
{
	for (const auto& it : gStaticDataCatalog->GetList<STATIC_ACHIEVEMENT>())
	{
		auto key = it->Get_c_achievement_sid();
		auto found = mAchievementDocMap.find(key);
		AchievementDoc* doc = (mAchievementDocMap.end() != found) ? 
			found->second : _NEW<AchievementDoc>();
		doc->mStaticAchievement = *it;
		mAchievementDocMap.emplace(key, doc);
		
		doc->mStaticAchievementStepList.clear();
		doc->mRewardDocList.clear();
	}

	for (const auto& it : gStaticDataCatalog->GetList<STATIC_ACHIEVEMENT_STEP>())
	{
		auto key = it->Get_c_achievement_sid();
		auto found = mAchievementDocMap.find(key);
		_ASSERT_CRASH(mAchievementDocMap.end() != found);
		AchievementDoc* doc = found->second;
		doc->mStaticAchievementStepList.emplace_back(*it);
	}
}

void AchievementDocLookup::Link()
{
	const std::shared_ptr<RewardDocLookup> rewardDocLookup = gStaticDataAccessor->Get<RewardDocLookup>();

	for (auto& [_, doc] : mAchievementDocMap)
	{
		doc->mRewardDocList.resize(doc->mStaticAchievementStepList.size());

		for (const STATIC_ACHIEVEMENT_STEP* staticAchievementStep : doc->mStaticAchievementStepList)
		{
			staticAchievementStep;
		}
	}
}

const AchievementDoc* AchievementDocLookup::Find(AchievementSid achievementSid) const
{
	const auto it = mAchievementDocMap.find(achievementSid);

	if (mAchievementDocMap.end() == it)
	{
		_DEBUG_BREAK;
		_DEBUG_RED;
		return nullptr;
	}

	return it->second;
}
