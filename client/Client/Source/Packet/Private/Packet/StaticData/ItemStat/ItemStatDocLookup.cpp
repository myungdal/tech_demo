// ============================================================================
// myungdal tech-demo project
// 
// Author: 안명달 (Myungdal Ahn)
// Email: mooondal@gmail.com
// GitHub: https://github.com/myungdal/tech_demo.git
// ============================================================================

#include "Packet/StaticData/ItemStat/ItemStatDocLookup.h"

#include "Common/Stat/statContainer/StatContainer.h"

#include "Packet/BasePacketAutoGenerated/PACKET_COMMON.h"
#include "Packet/StaticDataAccessor/StaticDataAccessor.h"
#include "Packet/StaticDataCatalog/StaticDataCatalog.h"
#include "Packet/StaticData/ItemStat/ItemStatDoc.h"


ItemStatDocLookup::~ItemStatDocLookup()
{
	Clear();
}
void ItemStatDocLookup::Clear()
{
	for (auto& it : mItemStatDocMap)
	{
		ItemStatDoc* doc = it.second;

		_DELETE(doc);
	}
	mItemStatDocMap.clear();
}

void ItemStatDocLookup::Load()
{
	for (const auto& it : gStaticDataCatalog->GetList<STATIC_ITEM_STAT>())
	{
		auto key = it->Get_c_item_sid();
		auto found = mItemStatDocMap.find(key);
		ItemStatDoc* doc = (mItemStatDocMap.end() != found) ? found->second : _NEW<ItemStatDoc>();
		doc->mStaticItemStatList.emplace_back(*it);
		mItemStatDocMap.emplace(key, doc);
	}
}

void ItemStatDocLookup::Link()
{
	{
		StatArray statArray;

		for (auto& [sid, doc] : mItemStatDocMap)
		{
			if (!doc->mStatContainer)
				doc->mStatContainer = std::make_shared<StatContainer>();

			statArray.fill(0);
			for (const STATIC_ITEM_STAT* stat : doc->mStaticItemStatList)
				statArray.at((size_t)stat->Get_c_stat_type()) = stat->Get_c_stat_value();

			doc->mStatContainer->MergeFromStatValues(statArray);
		}
	}
}

const ItemStatDoc* ItemStatDocLookup::Find(ItemSid itemSid) const
{
	const auto it = mItemStatDocMap.find(itemSid);

	if (mItemStatDocMap.end() == it)
	{
		//_DEBUG_BREAK;
		//_DEBUG_RED;
		return nullptr;
	}

	return it->second;
}
