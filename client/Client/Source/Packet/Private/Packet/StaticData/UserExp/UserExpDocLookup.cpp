// ============================================================================
// myungdal tech-demo project
// 
// Author: 안명달 (Myungdal Ahn)
// Email: mooondal@gmail.com
// GitHub: https://github.com/myungdal/tech_demo.git
// ============================================================================

#include "Packet/StaticData/UserExp/UserExpDocLookup.h"

#include "Packet/BasePacketAutoGenerated/PACKET_COMMON.h"
#include "Packet/StaticDataAccessor/StaticDataAccessor.h"
#include "Packet/StaticDataCatalog/StaticDataCatalog.h"
#include "Packet/StaticData/UserExp/UserExpDoc.h"


UserExpDocLookup::~UserExpDocLookup()
{
	Clear();
}
void UserExpDocLookup::Clear()
{
	for (auto& [_, doc] : mUserExpDocMap)
	{
		_DELETE(doc);
	}
	mUserExpDocMap.clear();
}

void UserExpDocLookup::Load()
{
	for (auto& it : gStaticDataCatalog->GetList<STATIC_USER_EXP>())
	{
		auto key = it->Get_c_user_exp();
		auto found = mUserExpDocMap.find(key);
		UserExpDoc* doc = (mUserExpDocMap.end() != found) ? found->second : _NEW<UserExpDoc>();
		doc->mUserExp = *it;
		mUserExpDocMap.emplace(key, doc);
	}
}

void UserExpDocLookup::Link()
{
}

const UserExpDoc* UserExpDocLookup::FindByExp(UserExp userExp) const
{
	if (mUserExpDocMap.empty())
		return nullptr;

	// userExp 보다 큰 첫번 째 원소.
	auto it = mUserExpDocMap.upper_bound(userExp);

	if (it == mUserExpDocMap.begin()) 
		return nullptr; 

	// userExp 보다 작거나 같은 원소.
	--it;

	return it->second;
}

const UserExpDoc* UserExpDocLookup::FindByLevel(UserLevel userLevel) const
{
	if (mUserExpDocMap.empty())
		return nullptr;

	auto it = mUserExpDocMap.begin();

	for (; it != mUserExpDocMap.end(); ++it)
	{
		const UserExpDoc* doc = it->second;
		if (!doc || !doc->mUserExp)
			continue;

		if (doc->mUserExp->Get_c_user_level() == userLevel)
			return doc;
	}

	return nullptr;
}
