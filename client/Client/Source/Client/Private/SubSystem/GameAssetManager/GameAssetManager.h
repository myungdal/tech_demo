// ============================================================================
// myungdal tech-demo project
// 
// Author: 안명달 (Myungdal Ahn)
// Email: mooondal@gmail.com
// GitHub: https://github.com/myungdal/tech_demo.git
// ============================================================================


#pragma once

#include "Common/EnumAutoGenerated/Enum.h"
#include "Styling/SlateBrush.h"

#include "Subsystems/GameInstanceSubsystem.h"
#include "Engine/GameInstance.h"
#include "Engine/World.h"
#include "GameAssetManager.generated.h"


class UCharacterAnimSet;
class UEffectAnimSequence;

UCLASS()
class UGameAssetManager : public UGameInstanceSubsystem
{
	GENERATED_BODY()

private:
	UPROPERTY(Transient)
	TArray<UCharacterAnimSet*> mCharacterAnimSets;
	
	UPROPERTY(Transient)
	TArray<UEffectAnimSequence*> mEffectAnimSequences;

private:
	using BrushArray = TArray<FSlateBrush>;
	using BrushTable = TArray<BrushArray>;

private:
	BrushTable mPropTable;

public:
	template<typename T>
	static UGameAssetManager* Get(T* obj)
	{
		UWorld* world = nullptr;
		if constexpr (THasGetWorld<T>::value)
			world = obj->GetWorld();
		else
			world = gCurrWorld;

		if (world)
			if (UGameInstance* gameInstance = world->GetGameInstance())
				return gameInstance->GetSubsystem<UGameAssetManager>();

		return nullptr;
	}

public:
	virtual void Initialize(FSubsystemCollectionBase& Collection) override;
	virtual void Deinitialize() override;

public:
	void OnInitialize();
	void OnRelease();

public:
	const UCharacterAnimSet* GetCharacterAnimSet(CharacterType characterType) const noexcept;
	const FSlateBrush* GetCharacterBrush(CharacterType characterType, CharacterAnimType animationType, float timePos) const noexcept;
	const FSlateBrush* GetPropBrush(int propIdx, int spriteIdx) const noexcept;
	
	const UEffectAnimSequence* GetEffectAnimSequence(EffectAnimType effectType) const noexcept;
	const FSlateBrush* GetEffectBrush(EffectAnimType effectType, float timePos) const noexcept;
};

#define GET_GAME_ASSET_MANAGER UGameAssetManager::Get
