// ============================================================================
// myungdal tech-demo project
// 
// Author: 안명달 (Myungdal Ahn)
// Email: mooondal@gmail.com
// GitHub: https://github.com/myungdal/tech_demo.git
// ============================================================================

#include "NetworkContext.h"

#include "Packet/StaticDataAccessor/StaticDataAccessor.h"
#include "Packet/StaticDataCatalog/StaticDataCatalog.h"
#include "Packet/UserCacheAccessor/UserCacheAccessor.h"
#include "Packet/UserCache/UserItem/UserItemTable.h"

#include "Serialization/JsonWriter.h"
#include "Dom/JsonValue.h"
#include "Dom/JsonObject.h"
#include "Engine/GameInstance.h"
#include "Engine/World.h"

#include "SubSystem/UiServiceManager/UiServiceManager.h"
#include "SubSystem/NetworkManager/SendBuffer/TempBuffer.h"
#include "ClientUtil/ClientStringUtil.h"
#include "ClientUtil/ClientFileUtil.h"
#include "UiEvent/AutoGenerated/UiEvent.h"


void UNetworkContext::Initialize(FSubsystemCollectionBase& Collection)
{
	Super::Initialize(Collection);
	OnInitialize();
}

void UNetworkContext::Deinitialize()
{
	OnRelease();
	Super::Deinitialize();
}

void UNetworkContext::OnInitialize()
{
	StaticDataIndexList staticDataIndexListForGameServer;
	StaticDataIndexList staticDataIndexListForClient;
	ReadStaticDataIndexList(staticDataIndexListForClient);
	gStaticDataCatalog =
		MakeShared<StaticDataCatalog>(
			staticDataIndexListForGameServer,
			staticDataIndexListForClient
		);

	gStaticDataAccessor = MakeShared<StaticDataAccessor>();

	mUserCacheAccessor = MakeShared<UserCacheAccessor>();

	LoadStaticData();
}

void UNetworkContext::OnRelease()
{
}

void UNetworkContext::OnDisconnected()
{
	mAuthTicket = INVALID_AUTH_TICKET;

	mNextGameId = INVALID_UUID;
	mCurrGameId = INVALID_UUID;

	mCurrPacketHeader = {};
}

void UNetworkContext::OnFatalError()
{
	mAuthTicket = INVALID_AUTH_TICKET;

	mNextGameId = INVALID_UUID;
	mCurrGameId = INVALID_UUID;

	mCurrPacketHeader = {};
}

void UNetworkContext::ReadStaticDataIndexList(OUT StaticDataIndexList& container) const
{
	TSharedPtr<FJsonObject> jsonRoot = FClientFileUtil::LoadJsonFile(TEXT("staticDataIndexList.json"));
	if (nullptr == jsonRoot)
		return;

	const TArray<TSharedPtr<FJsonValue>>* idxList;
	if (false == jsonRoot->TryGetArrayField(TEXT("idxList"), idxList))
		return;

	for (int32 i = 0; i < idxList->Num(); ++i)
	{
		int32 idx;
		if (true == (*idxList)[i]->TryGetNumber(idx))
			container.emplace_back(idx);
	}
}

void UNetworkContext::LoadStaticData()
{
	TSharedPtr<FJsonObject> jsonRoot = FClientFileUtil::LoadJsonFile(TEXT("staticDataChecksum.json"));
	if (nullptr == jsonRoot)
		return;

	int32 arraySize = 0;
	if ((false == jsonRoot->TryGetNumberField(TEXT("checksum0"), gStaticDataCatalog->ExpectedChecksumForClient().checksum0)) ||
		(false == jsonRoot->TryGetNumberField(TEXT("checksum1"), gStaticDataCatalog->ExpectedChecksumForClient().checksum1)) ||
		(false == jsonRoot->TryGetNumberField(TEXT("checksum2"), gStaticDataCatalog->ExpectedChecksumForClient().checksum2)) ||
		(false == jsonRoot->TryGetNumberField(TEXT("checksum3"), gStaticDataCatalog->ExpectedChecksumForClient().checksum3)) ||
		(false == jsonRoot->TryGetNumberField(TEXT("arraySize"), arraySize)))
	{
		return;
	}

	gStaticDataCatalog->ExpectedSizeList().resize(arraySize);
	{
		const TArray<TSharedPtr<FJsonValue>>* sizeList;
		if (false == jsonRoot->TryGetArrayField(TEXT("mSizeList"), sizeList))
			return;

		for (int32 i = 0; i < sizeList->Num(); ++i)
		{
			int32 size;

			if (false == (*sizeList)[i]->TryGetNumber(size))
				return;

			gStaticDataCatalog->ExpectedSizeList().at(i) = size;
		}
	}

	gStaticDataCatalog->ExpectedChecksumList().resize(arraySize);
	{
		const TArray<TSharedPtr<FJsonValue>>* checksumList;
		if (false == jsonRoot->TryGetArrayField(TEXT("mChecksumList"), checksumList))
			return;

		for (int32 i = 0; i < checksumList->Num(); ++i)
		{
			const TSharedPtr<FJsonObject>* checksumObj;
			if (false == (*checksumList)[i]->TryGetObject(checksumObj))
				return;

			if ((false == (*checksumObj)->TryGetNumberField(TEXT("checksum0"), gStaticDataCatalog->ExpectedChecksumList().at(i).checksum0)) ||
				(false == (*checksumObj)->TryGetNumberField(TEXT("checksum1"), gStaticDataCatalog->ExpectedChecksumList().at(i).checksum1)) ||
				(false == (*checksumObj)->TryGetNumberField(TEXT("checksum2"), gStaticDataCatalog->ExpectedChecksumList().at(i).checksum2)) ||
				(false == (*checksumObj)->TryGetNumberField(TEXT("checksum3"), gStaticDataCatalog->ExpectedChecksumList().at(i).checksum3)))
			{
				return;
			}
		}
	}

	gStaticDataCatalog->BinaryList().resize(arraySize);
	for (int32 i = 0; i < arraySize; ++i)
	{
		TArray<uint8_t> byteArray = FClientFileUtil::LoadByteArrayFile(FString::Printf(TEXT("staticData%03d.dat"), i));

		if (0 == byteArray.Num())
			continue;

		const size_t size = gStaticDataCatalog->ExpectedSizeList().at(i);
		if (size != byteArray.Num())
			return;

		if (gStaticDataCatalog->BinaryList().at(i))
		{
			_FREE(reinterpret_cast<void*>(gStaticDataCatalog->BinaryList().at(i)));
			gStaticDataCatalog->BinaryList().at(i) = nullptr;
		}

		gStaticDataCatalog->BinaryList().at(i) = _MALLOC<uint8_t>(size);
		std::copy_n(byteArray.GetData(), size, gStaticDataCatalog->BinaryList().at(i));
	}

	gStaticDataCatalog->SetSyncing();

	auto [succeeded, staticDataIndex] = gStaticDataCatalog->BuildDataForClient();
	if (true == succeeded)
	{
		gStaticDataAccessor = MakeShared<StaticDataAccessor>();
		gStaticDataAccessor->BuildView();
		gStaticDataCatalog->SetSynced();
	}
	else
	{
		gStaticDataCatalog->ResetSync();
	}
}

void UNetworkContext::SaveStaticData() const
{
	int32 arraySize = static_cast<int32>(gStaticDataCatalog->GetMySizeList().size());

	FString jsonStr;
	TSharedRef<TJsonWriter<>> jsonWriter = TJsonWriterFactory<>::Create(&jsonStr);
	jsonWriter->WriteObjectStart();
	jsonWriter->WriteValue(TEXT("checksum0"), FString::Printf(TEXT("%u"), gStaticDataCatalog->GetMyChecksumForClient().checksum0));
	jsonWriter->WriteValue(TEXT("checksum1"), FString::Printf(TEXT("%u"), gStaticDataCatalog->GetMyChecksumForClient().checksum1));
	jsonWriter->WriteValue(TEXT("checksum2"), FString::Printf(TEXT("%u"), gStaticDataCatalog->GetMyChecksumForClient().checksum2));
	jsonWriter->WriteValue(TEXT("checksum3"), FString::Printf(TEXT("%u"), gStaticDataCatalog->GetMyChecksumForClient().checksum3));
	jsonWriter->WriteValue(TEXT("arraySize"), FString::Printf(TEXT("%d"), arraySize));
	jsonWriter->WriteArrayStart(TEXT("mSizeList"));
	for (int32 i = 0; i < arraySize; ++i)
	{
		int32 size = static_cast<int32>(gStaticDataCatalog->GetMySizeList().at(i));
		jsonWriter->WriteValue(FString::Printf(TEXT("%d"), size));
	}
	jsonWriter->WriteArrayEnd();
	jsonWriter->WriteArrayStart(TEXT("mChecksumList"));
	for (int32 i = 0; i < arraySize; ++i)
	{
		jsonWriter->WriteObjectStart();
		jsonWriter->WriteValue(TEXT("checksum0"), FString::Printf(TEXT("%u"), gStaticDataCatalog->GetMyChecksumList().at(i).checksum0));
		jsonWriter->WriteValue(TEXT("checksum1"), FString::Printf(TEXT("%u"), gStaticDataCatalog->GetMyChecksumList().at(i).checksum1));
		jsonWriter->WriteValue(TEXT("checksum2"), FString::Printf(TEXT("%u"), gStaticDataCatalog->GetMyChecksumList().at(i).checksum2));
		jsonWriter->WriteValue(TEXT("checksum3"), FString::Printf(TEXT("%u"), gStaticDataCatalog->GetMyChecksumList().at(i).checksum3));
		jsonWriter->WriteObjectEnd();
	}
	jsonWriter->WriteArrayEnd();
	jsonWriter->WriteObjectEnd();
	jsonWriter->Close();

	if (false == FClientFileUtil::SaveTxtFile(TEXT("staticDataChecksum.json"), jsonStr))
		return;

	for (int32 i = 0; i < arraySize; ++i)
	{
		const int32 size = gStaticDataCatalog->GetMySizeList().at(i);
		TArray<uint8_t> byteArray;
		byteArray.SetNumUninitialized(size);
		if (size > 0)
		{
			std::copy_n(gStaticDataCatalog->BinaryList().at(i), size, byteArray.GetData());
		}
		FClientFileUtil::SaveByteArrayFile(FString::Printf(TEXT("staticData%03d.dat"), i), byteArray);
	}
}

bool UNetworkContext::LoadAccountJsonFile()
{
	TSharedPtr<FJsonObject> jsonRoot = FClientFileUtil::LoadJsonFile(TEXT("account.json"));
	if (nullptr == jsonRoot)
		return false;

	FString accountId;
	FString deviceToken;
	FString googleToken;
	FString appleToken;
	if ((false == jsonRoot->TryGetStringField(TEXT("mAccountId"), accountId)) ||
		(false == jsonRoot->TryGetStringField(TEXT("mDeviceToken"), deviceToken)) ||
		(false == jsonRoot->TryGetStringField(TEXT("mGoogleToken"), googleToken)) ||
		(false == jsonRoot->TryGetStringField(TEXT("mAppleToken"), appleToken)))
	{
		return false;
	}

	FTempBuffer buffer;
	ACCOUNT::Writer wp(PARAM, *buffer,
		FCString::Atoi64(*accountId),
		*ClientStringUtil::s_to_w(deviceToken),
		*ClientStringUtil::s_to_w(googleToken),
		*ClientStringUtil::s_to_w(appleToken),
		INVALID_DB_SHARD_IDX,
		AccountState::NONE,
		time_t{ 0 },
		time_t{ 0 },
		time_t{ 0 }
	);
	mAccount = wp.GetPacketBufPtr();

	return true;
}

void UNetworkContext::SaveAccount() const
{
	FString jsonStr;
	TSharedRef<TJsonWriter<>> jsonWriter = TJsonWriterFactory<>::Create(&jsonStr);
	jsonWriter->WriteObjectStart();
	if (false == mAccount.IsEmpty())
	{
		jsonWriter->WriteValue(TEXT("mAccountId"), FString::Printf(TEXT("%llu"), mAccount->Get_c_account_id().GetData()));
		jsonWriter->WriteValue(TEXT("mDeviceToken"), ClientStringUtil::w_to_s(mAccount->Get_c_device_token()));
		jsonWriter->WriteValue(TEXT("mGoogleToken"), ClientStringUtil::w_to_s(mAccount->Get_c_google_token()));
		jsonWriter->WriteValue(TEXT("mAppleToken"), ClientStringUtil::w_to_s(mAccount->Get_c_apple_token()));
	}
	else
	{
		jsonWriter->WriteValue(TEXT("mAccountId"), TEXT(""));
		jsonWriter->WriteValue(TEXT("mDeviceToken"), TEXT(""));
		jsonWriter->WriteValue(TEXT("mGoogleToken"), TEXT(""));
		jsonWriter->WriteValue(TEXT("mAppleToken"), TEXT(""));
	}
	jsonWriter->WriteObjectEnd();
	jsonWriter->Close();

	FClientFileUtil::SaveTxtFile(TEXT("account.json"), jsonStr);

	UUiServiceManager::Get(this)->BroadcastUiEvent<UUiEvent_LOAD_ACCOUNT>();
}

UserItemRowPtr UNetworkContext::FindItemIdByItemSid(ItemSid itemSid) const
{
	if (UserItemTablePtr userItemTable = mUserCacheAccessor->Get<UserItemTable>())
	{
		return userItemTable->FindItemByItemSid(itemSid);
	}

	return nullptr;
}


