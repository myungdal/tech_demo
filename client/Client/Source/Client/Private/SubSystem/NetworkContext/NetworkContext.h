// ============================================================================
// myungdal tech-demo project
// 
// Author: 안명달 (Myungdal Ahn)
// Email: mooondal@gmail.com
// GitHub: https://github.com/myungdal/tech_demo.git
// ============================================================================


#pragma once

#include "Packet/BasePacketAutoGenerated/PACKET_COMMON.h"

#include "Subsystems/GameInstanceSubsystem.h"
#include "Engine/GameInstance.h"
#include "Engine/World.h"
#include "NetworkContext.generated.h"


class UserCacheAccessor;
class SERVER;
class ACCOUNT_USER;
class GAME;

using ServerList = std::list<PacketKeep<SERVER>>;
using AccountUserList = std::list<PacketKeep<ACCOUNT_USER>>;
using UserCacheAccessorPtr = TSharedPtr<UserCacheAccessor>;
using GameList = std::unordered_map<GameId, PacketKeep<GAME>>;

/**
 * 네트워크 컨텍스트(클라이언트 세션 상태).
 * 계정/유저/서버 리스트/패킷 헤더 등 런타임 상태를 보관합니다.
 */
UCLASS()
class UNetworkContext : public UGameInstanceSubsystem
{
	GENERATED_BODY()

protected:
	PacketKeep<ACCOUNT> mAccount; // 로컬에서 생성한 것	

protected:
	PacketHeader mCurrPacketHeader;

protected:
	ServerList mServerList;
	AccountUserList mAccountUserList;	
	AuthTicket mAuthTicket = INVALID_AUTH_TICKET;
	PacketKeep<ACCOUNT_USER> mAccountUser;

	Checksum mStaticDataChecksum;
	UserCacheAccessorPtr mUserCacheAccessor = nullptr;

	GameList mGameList;
	GameId mNextGameId = INVALID_UUID;
	GameId mCurrGameId = INVALID_UUID;

	std::wstring mNewUserName;

public:
	template<typename T>
	static UNetworkContext* Get(T* obj)
	{
		UWorld* world = nullptr;
		if constexpr (THasGetWorld<T>::value)
			world = obj->GetWorld();
		else
			world = gCurrWorld;

		if (world)
			if (UGameInstance* gameInstance = world->GetGameInstance())
				return gameInstance->GetSubsystem<UNetworkContext>();

		return nullptr;
	}

	virtual void Initialize(FSubsystemCollectionBase& Collection) override;
	virtual void Deinitialize() override;

private:
	void OnInitialize();
	void OnRelease();

public:
	void OnDisconnected();
	void OnFatalError();

public:
	void ReadStaticDataIndexList(OUT StaticDataIndexList& container) const;
	void LoadStaticData();
	void SaveStaticData() const;

	bool LoadAccountJsonFile();
	void SaveAccount() const;
	PacketKeep<ACCOUNT>& Account() { return mAccount; }	

public:
	const PacketHeader& CurrPacketHeader() const { return mCurrPacketHeader; }
	PacketHeader& CurrPacketHeader() { return mCurrPacketHeader; }

	ServerList& ServerList() { return mServerList; }
	AccountUserList& AccountUserList() { return mAccountUserList; }	
	AuthTicket& AuthTicket() { return mAuthTicket; }
	PacketKeep<ACCOUNT_USER>& AccountUser() { return mAccountUser; }
	Checksum& StaticDataChecksum() { return mStaticDataChecksum; }

	UserCacheAccessor& GetUserCacheAccessor() { return *mUserCacheAccessor; }

	GameList& GetGameList() { return mGameList; }

	void SetNextGameId(const GameId& val) { mNextGameId = val; }
	const GameId& GetNextGameId() const { return mNextGameId; }

	void SetCurrGameId(const GameId& val) { mCurrGameId = val; }
	const GameId& GetCurrGameId() const { return mCurrGameId; }

	void SetNewUserName(const std::wstring& val) { mNewUserName = val; }
	const std::wstring& GetNewUserName() const { return mNewUserName; }

public:
	UserItemRowPtr FindItemIdByItemSid(ItemSid itemSid) const;
};

