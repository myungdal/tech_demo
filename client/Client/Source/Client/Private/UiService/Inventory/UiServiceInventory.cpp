// ============================================================================
// myungdal tech-demo project
// 
// Author: 안명달 (Myungdal Ahn)
// Email: mooondal@gmail.com
// GitHub: https://github.com/myungdal/tech_demo.git
// ============================================================================

#include "UiServiceInventory.h"

#include "Packet/NetworkPacketAutoGenerated/PACKET_CF.h"
#include "Packet/StaticData/Item/ItemDoc.h"
#include "Packet/StaticData/Item/ItemDocLookup.h"
#include "Packet/UserCacheAccessor/UserCacheAccessor.h"
#include "Packet/UserCache/UserItem/UserItemRow.h"
#include "Packet/UserCache/UserItem/UserItemTable.h"

#include "SubSystem/UiServiceManager/UiServiceManager.h"
#include "SubSystem/NetworkManager/NetworkManager.h"
#include "SubSystem/NetworkContext/NetworkContext.h"
#include "Util/PacketUtil/PacketUtil.h"


void FUiServiceInventory::SelectItem(const UserItemRow* userItemRow)
{
	switch(mCurrentItemDetailOpenEventType)
	{
	case UUiEvent_ITEM_DETAIL_STONE_OPEN::TYPE:
	{
		if (ItemType::STONE == userItemRow->GetDoc()->mStaticItem->Get_c_item_type())
		{
			if (nullptr == mSelectedItem0)
			{
				mSelectedItem0 = userItemRow;
			}
			else
			{
				mSelectedItem1 = userItemRow;
			}
			UpdateItemInfoList();
		}
		break;
	}
	default:
	{
		mSelectedItem0 = userItemRow;
		mSelectedItem1 = nullptr;
		OpenItemDetail();
		break;
	}
	}

	UUiServiceManager::Get(this)->BroadcastUiEvent<UUiEvent_ITEM_DETAIL_RELOAD>();
}

void FUiServiceInventory::DeselectItem(const UserItemRow* userItemRow)
{
	switch (mCurrentItemDetailOpenEventType)
	{
	case UUiEvent_ITEM_DETAIL_STONE_OPEN::TYPE:
	{
		if (mSelectedItem0 == userItemRow)
			mSelectedItem0 = nullptr;

		if (mSelectedItem1 == userItemRow)
			mSelectedItem1 = nullptr;

		if (nullptr == mSelectedItem0)
		{
			mSelectedItem0 = mSelectedItem1;
			mSelectedItem1 = nullptr;
		}

		UpdateItemInfoList();
		UUiServiceManager::Get(this)->BroadcastUiEvent<UUiEvent_ITEM_DETAIL_RELOAD>();
		break;
	}
	default:
	{
		break;
	}
	}
}

bool FUiServiceInventory::IsIncludedCurrentTab(ItemType itemType) const
{
	if ((UUiEvent_INVENTORY_TAB_STONE_CLICKED::TYPE == mCurrentTabBtnEventType) &&
		(ItemType::STONE != itemType))
	{
		return false;
	}

	if ((UUiEvent_INVENTORY_TAB_ETC_CLICKED::TYPE == mCurrentTabBtnEventType) &&
		(ItemType::STONE == itemType))
	{
		return false;
	}

	return true;
}

void FUiServiceInventory::OpenItemDetail()
{
	if (nullptr == mSelectedItem0)
		return;
	
	switch (mSelectedItem0->GetDoc()->mStaticItem->Get_c_item_type())
	{
	//case ItemType::LAUNCH_GAME:
	//{
	//	mCurrentItemDetailOpenEventType = UUiEvent_ITEM_DETAIL_LAUNCH_GAME_OPEN::TYPE;
	//	UUiServiceManager::Get(this)->BroadcastUiEvent<UUiEvent_ITEM_DETAIL_LAUNCH_GAME_OPEN>();
	//	break;
	//}
	case ItemType::REWARD_BOX:
	{
		mCurrentItemDetailOpenEventType = UUiEvent_ITEM_DETAIL_REWARD_OPEN::TYPE;
		UUiServiceManager::Get(this)->BroadcastUiEvent<UUiEvent_ITEM_DETAIL_REWARD_OPEN>();
		break;
	}
	case ItemType::STONE:
	{
		mCurrentItemDetailOpenEventType = UUiEvent_ITEM_DETAIL_STONE_OPEN::TYPE;
		UUiServiceManager::Get(this)->BroadcastUiEvent<UUiEvent_ITEM_DETAIL_STONE_OPEN>();
		// 탭 자동 전환.
		UUiServiceManager::Get(this)->BroadcastUiEvent<UUiEvent_INVENTORY_TAB_STONE_CLICKED>();
		break;
	}
	default:
	{
		break;
	}
	}
}

void FUiServiceInventory::UpdateRedDotItemSet(const class USER_CACHE_DIFF& rp)
{
	bool hasRedDot = false;
	for (const ITEM* item : rp.Get_itemList())
	{
		const ItemId& itemId = item->Get_c_item_id();
		mRedDotItemSet.Add(itemId);
		hasRedDot = true;
	}

	if (true == hasRedDot)
	{
		UUiServiceManager::Get(this)->BroadcastUiEvent<UUiEvent_RED_DOT_ADD>(RedDotType::INVENTORY);
	}
}

void FUiServiceInventory::UpdateItemInfoList()
{
	mInventoryItemList.Empty();

	// 필터.
	UserCacheAccessor& userCacheAccessor = UNetworkContext::Get(this)->GetUserCacheAccessor();
	for (const auto& it : userCacheAccessor.Get<UserItemTable>()->Data())
	{
		const UserItemRowPtr userCacheItem = it.second;
		const ItemType itemType = userCacheItem->GetDoc()->mStaticItem->Get_c_item_type();

		// 현재 탭에 포함되지 않으면 건너 뜀.
		if (false == IsIncludedCurrentTab(itemType))
			continue;

		// 0개면 건너 뜀.
		if (0 == userCacheItem->Data().Get_c_item_quantity())
			continue;

		FUiServiceInventoryItemDisplayOpt displayOpt;

		if (UUiEvent_ITEM_DETAIL_STONE_OPEN::TYPE == mCurrentItemDetailOpenEventType)
		{
			// STONE 창은 STONE 만 보여 줌.
			if (ItemType::STONE != itemType)
				displayOpt.mDisabled = true;

			//// mSelectedItem0 과 합성 가능해야 함.
			//if (nullptr != mSelectedItem0)
			//	displayOpt.mDisabled = mSelectedItem0->CanStoneMerge(userCacheItem) ? false : true;
		}

		displayOpt.mRedDot = mRedDotItemSet.Contains(userCacheItem->Data().Get_c_item_id());

		mInventoryItemList.Emplace(std::make_pair(userCacheItem, displayOpt));
	}

	// 정렬.
	mInventoryItemList.Sort(
		[](const InventoryItem& item0, const InventoryItem& item1)
		{
			const FUiServiceInventoryItemDisplayOpt& displayOpt0 = item0.second;
			const FUiServiceInventoryItemDisplayOpt& displayOpt1 = item1.second;

			if ((displayOpt0.mDisabled && !displayOpt1.mDisabled) || (!displayOpt0.mDisabled && displayOpt1.mDisabled))
				return displayOpt1.mDisabled;

			if ((displayOpt0.mRedDot && !displayOpt1.mRedDot) || (!displayOpt0.mRedDot && displayOpt1.mRedDot))
				return displayOpt1.mRedDot;

			return item0.first->GetDoc()->mStaticItem->Get_c_item_sid() < item0.first->GetDoc()->mStaticItem->Get_c_item_sid();
		}
	);
	
	UUiServiceManager::Get(this)->BroadcastUiEvent<UUiEvent_INVENTORY_ITEM_LIST_RELOAD>();
}

void FUiServiceInventory::OnDispatchUiEvent(UUiEventBase* uiEvent)
{
	DispatchUiEvent(this, uiEvent);
}

void FUiServiceInventory::OnUiEvent(UUiEvent_RED_DOT_UPDATED& uiEvent)
{
	UpdateItemInfoList();
}

void FUiServiceInventory::OnUiEvent(UUiEvent_INVENTORY_OPEN& uiEvent)
{
	UUiServiceManager::Get(this)->BroadcastUiEvent<UUiEvent_INVENTORY_TAB_STATE_UPDATE>();
}

void FUiServiceInventory::OnUiEvent(UUiEvent_INVENTORY_CLOSE_CLICKED& uiEvent)
{
	mRedDotItemSet.Empty(0);

	UUiServiceManager::Get(this)->BroadcastUiEvent<UUiEvent_RED_DOT_REMOVE>(RedDotType::INVENTORY);
}

void FUiServiceInventory::OnUiEvent(UUiEvent_INVENTORY_TAB_ALL_CLICKED& uiEvent)
{
	mCurrentTabBtnEventType = UUiEvent_INVENTORY_TAB_ALL_CLICKED::TYPE;
	UUiServiceManager::Get(this)->BroadcastUiEvent<UUiEvent_INVENTORY_TAB_STATE_UPDATE>();
	UpdateItemInfoList();
}

void FUiServiceInventory::OnUiEvent(UUiEvent_INVENTORY_TAB_STONE_CLICKED& uiEvent)
{
	mCurrentTabBtnEventType = UUiEvent_INVENTORY_TAB_STONE_CLICKED::TYPE;
	UUiServiceManager::Get(this)->BroadcastUiEvent<UUiEvent_INVENTORY_TAB_STATE_UPDATE>();
	UpdateItemInfoList();
}

void FUiServiceInventory::OnUiEvent(UUiEvent_INVENTORY_TAB_ETC_CLICKED& uiEvent)
{
	mCurrentTabBtnEventType = UUiEvent_INVENTORY_TAB_ETC_CLICKED::TYPE;
	UUiServiceManager::Get(this)->BroadcastUiEvent<UUiEvent_INVENTORY_TAB_STATE_UPDATE>();
	UpdateItemInfoList();
}

void FUiServiceInventory::OnUiEvent(UUiEvent_ITEM_DETAIL_CLOSE_CLICKED& uiEvent)
{
	mSelectedItem1 = nullptr;
	mCurrentItemDetailOpenEventType = UUiEvent_NONE::TYPE;
	UpdateItemInfoList();
}

//void FUiServiceInventory::OnUiEvent(UUiEvent_ITEM_LAUNCH_GAME_CLICKED& uiEvent)
//{
//	if (const UserItemRow* userItemRow = mSelectedItem0)
//	{
//		ItemType itemType = userItemRow->GetDoc()->mStaticItem->Get_c_item_type();
//		if (ItemType::LAUNCH_GAME != itemType)
//		{
//			_DEBUG_LOG(RED, L"(ItemType::LAUNCH_GAME != itemType)");
//			return;
//		}
//
//		ItemId itemId = userItemRow->GetItem_id();
//
//		CF_REQ_GAME_LAUNCH::Writer wp(REQ, G_SB);
//		
//		wp.SetValues(itemId);
//
//		UNetworkManager::Get(this)->Send(wp);
//	}
//}

void FUiServiceInventory::OnDispatchPacket(NetworkPacket& rp)
{
	MAYBE_UNUSED const HandleResult handleResult = PacketUtil::DispatchPacket(this, rp);
}

HandleResult FUiServiceInventory::OnPacket(DC_ACK_USER_DATA& rp)
{
	UpdateItemInfoList();
	return HandleResult::OK;
}

HandleResult FUiServiceInventory::OnPacket(DC_ACK_CHEAT& rp)
{
	UpdateRedDotItemSet(rp.Get_userCacheDiff());
	UpdateItemInfoList();
	return HandleResult::OK;
}
//
//HandleResult FUiServiceInventory::OnPacket(FC_ACK_GAME_LAUNCH& rp)
//{
//	UpdateRedDotItemSet(rp.GetUserAssetDelta());
//	UpdateItemInfoList();
//	return HandleResult::OK;
//}
//
